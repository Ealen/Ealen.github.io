<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">






  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Geography Information Science, Remote Sensing, Python Programming, Design" />










<meta name="description" content="for Tech, Design and Fun!">
<meta property="og:type" content="website">
<meta property="og:title" content="Geo+SPV">
<meta property="og:url" content="https://ealen.github.io/page/9/index.html">
<meta property="og:site_name" content="Geo+SPV">
<meta property="og:description" content="for Tech, Design and Fun!">
<meta property="article:author" content="Yilun Liu">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":true,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://ealen.github.io/page/9/"/>





  <title>Geo+SPV - Wanna know what is "Geo+SPV"?</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-159339055-1', 'auto');
  ga('send', 'pageview');
</script>





<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Geo+SPV</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Wanna know what is "Geo+SPV"?</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ealen.github.io/e8d21636/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yilun Liu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Geo+SPV">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/e8d21636/" itemprop="url">nyc taxi</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-02T11:05:22+08:00">
                2020-03-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/GIS/" itemprop="url" rel="index">
                    <span itemprop="name">GIS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/e8d21636/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="e8d21636/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><figcaption><span>setup, include</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">knitr::opts_chunk$set(echo&#x3D;TRUE, error&#x3D;FALSE)</span><br></pre></td></tr></table></figure>

<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This is a comprehensive Exploratory Data Analysis for the <a href="https://www.kaggle.com/c/nyc-taxi-trip-duration" target="_blank" rel="noopener">New York City Taxi Trip Duration</a> competition with <a href="http://tidyverse.org/" target="_blank" rel="noopener">tidy R</a> and <a href="http://ggplot2.tidyverse.org/" target="_blank" rel="noopener">ggplot2</a>.</p>
<p><strong>The goal of this playground challenge</strong> is to predict the <em>duration of taxi rides in NYC</em> based on features like trip coordinates or pickup date and time. The <a href="https://www.kaggle.com/c/nyc-taxi-trip-duration/data" target="_blank" rel="noopener">data</a> comes in the shape of 1.5 million training observations (<code>../input/train.csv</code>) and 630k test observation (<code>../input/test.csv</code>). Each row contains one taxi trip.</p>
<p><strong>In this notebook</strong>, we will first study and visualise the original data, engineer new features, and examine potential outliers. Then we add two <strong>external data sets</strong> on the <a href="https://www.kaggle.com/mathijs/weather-data-in-new-york-city-2016" target="_blank" rel="noopener">NYC weather</a> and on the theoretically <a href="https://www.kaggle.com/oscarleo/new-york-city-taxi-with-osrm" target="_blank" rel="noopener">fastest routes</a>. We visualise and analyse the new features within these data sets and their impact on the target <em>trip_duration</em> values. Finally, we will make a brief excursion into viewing this challenge as a <strong>classification problem</strong> and finish this notebook with a <strong>simple XGBoost model</strong> that provides a basic prediction.</p>
<p>I hope that this notebook will help you in getting started with this challenge. There is lots of room for you to develop your own ideas for new features and visualisations. In particular the classification approach and the final model are only a basic starting point for you to improve and optimise them for better performance. As always, any feedback, questions, or constructive criticism are much appreciated.</p>
<p>Originally, this analysis contained a few <strong>hidden figures</strong>, due to the memory/run-time limitations of the Kernels environment at the time. This means that I had to disable a few auxilliary visualisations as the notebook grew towards its final stage. I tried to only remove those plots that didn’t affect the flow of the analysis too much. <em>All</em> of the corresponding code was still contained in this notebook and you can easily recover these hidden plots. Now, with the new and improved Kernel specs those plots are back in the “official” version. (On related matters, the movie <a href="http://www.imdb.com/title/tt4846340/" target="_blank" rel="noopener">hidden figures</a> is a pretty awesome piece of history for maths (and space) geeks like us ;-) )</p>
<p>Finally, I would like to <strong>thank everyone of you</strong> for viewing, upvoting, or commenting on this kernel! I’m still a beginner here on Kaggle and your support means a lot to me :-) . Also, thanks to <a href="https://www.kaggle.com/nockeddown" target="_blank" rel="noopener">NockedDown</a> for suggesting the new updated title pun in the comments! ;-)</p>
<p>Enough talk. Let’s get started:</p>
<h2 id="Load-libraries-and-helper-functions"><a href="#Load-libraries-and-helper-functions" class="headerlink" title="Load libraries and helper functions"></a>Load libraries and helper functions</h2><figure class="highlight plain"><figcaption><span>message </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">library(&#39;ggplot2&#39;) # visualisation</span><br><span class="line">library(&#39;scales&#39;) # visualisation</span><br><span class="line">library(&#39;grid&#39;) # visualisation</span><br><span class="line">library(&#39;RColorBrewer&#39;) # visualisation</span><br><span class="line">library(&#39;corrplot&#39;) # visualisation</span><br><span class="line">library(&#39;alluvial&#39;) # visualisation</span><br><span class="line">library(&#39;dplyr&#39;) # data manipulation</span><br><span class="line">library(&#39;readr&#39;) # input&#x2F;output</span><br><span class="line">library(&#39;data.table&#39;) # data manipulation</span><br><span class="line">library(&#39;tibble&#39;) # data wrangling</span><br><span class="line">library(&#39;tidyr&#39;) # data wrangling</span><br><span class="line">library(&#39;stringr&#39;) # string manipulation</span><br><span class="line">library(&#39;forcats&#39;) # factor manipulation</span><br><span class="line">library(&#39;lubridate&#39;) # date and time</span><br><span class="line">library(&#39;geosphere&#39;) # geospatial locations</span><br><span class="line">library(&#39;leaflet&#39;) # maps</span><br><span class="line">library(&#39;leaflet.extras&#39;) # maps</span><br><span class="line">library(&#39;maps&#39;) # maps</span><br><span class="line">library(&#39;xgboost&#39;) # modelling</span><br><span class="line">library(&#39;caret&#39;) # modelling</span><br></pre></td></tr></table></figure>

<p>We use the <em>multiplot</em> function, courtesy of <a href="http://www.cookbook-r.com/Graphs/Multiple_graphs_on_one_page_(ggplot2)/" target="_blank" rel="noopener">R Cookbooks</a> to create multi-panel plots.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"># Define multiple plot function</span><br><span class="line">#</span><br><span class="line"># ggplot objects can be passed in ..., or to plotlist (as a list of ggplot objects)</span><br><span class="line"># - cols:   Number of columns in layout</span><br><span class="line"># - layout: A matrix specifying the layout. If present, &#39;cols&#39; is ignored.</span><br><span class="line">#</span><br><span class="line"># If the layout is something like matrix(c(1,2,3,3), nrow&#x3D;2, byrow&#x3D;TRUE),</span><br><span class="line"># then plot 1 will go in the upper left, 2 will go in the upper right, and</span><br><span class="line"># 3 will go all the way across the bottom.</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">multiplot &lt;- function(..., plotlist&#x3D;NULL, file, cols&#x3D;1, layout&#x3D;NULL) &#123;</span><br><span class="line"></span><br><span class="line">  # Make a list from the ... arguments and plotlist</span><br><span class="line">  plots &lt;- c(list(...), plotlist)</span><br><span class="line"></span><br><span class="line">  numPlots &#x3D; length(plots)</span><br><span class="line"></span><br><span class="line">  # If layout is NULL, then use &#39;cols&#39; to determine layout</span><br><span class="line">  if (is.null(layout)) &#123;</span><br><span class="line">    # Make the panel</span><br><span class="line">    # ncol: Number of columns of plots</span><br><span class="line">    # nrow: Number of rows needed, calculated from # of cols</span><br><span class="line">    layout &lt;- matrix(seq(1, cols * ceiling(numPlots&#x2F;cols)),</span><br><span class="line">                    ncol &#x3D; cols, nrow &#x3D; ceiling(numPlots&#x2F;cols))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> if (numPlots&#x3D;&#x3D;1) &#123;</span><br><span class="line">    print(plots[[1]])</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    # Set up the page</span><br><span class="line">    grid.newpage()</span><br><span class="line">    pushViewport(viewport(layout &#x3D; grid.layout(nrow(layout), ncol(layout))))</span><br><span class="line"></span><br><span class="line">    # Make each plot, in the correct location</span><br><span class="line">    for (i in 1:numPlots) &#123;</span><br><span class="line">      # Get the i,j matrix positions of the regions that contain this subplot</span><br><span class="line">      matchidx &lt;- as.data.frame(which(layout &#x3D;&#x3D; i, arr.ind &#x3D; TRUE))</span><br><span class="line"></span><br><span class="line">      print(plots[[i]], vp &#x3D; viewport(layout.pos.row &#x3D; matchidx$row,</span><br><span class="line">                                      layout.pos.col &#x3D; matchidx$col))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Load-data"><a href="#Load-data" class="headerlink" title="Load data"></a>Load data</h2><p>We use <em>data.table’s</em> fread function to speed up reading in the data:</p>
<figure class="highlight plain"><figcaption><span>warning</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">train &lt;- as.tibble(fread(&#39;..&#x2F;input&#x2F;nyc-taxi-trip-duration&#x2F;train.csv&#39;))</span><br><span class="line">test &lt;- as.tibble(fread(&#39;..&#x2F;input&#x2F;nyc-taxi-trip-duration&#x2F;test.csv&#39;))</span><br><span class="line">sample_submit &lt;- as.tibble(fread(&#39;..&#x2F;input&#x2F;nyc-taxi-trip-duration&#x2F;sample_submission.csv&#39;))</span><br></pre></td></tr></table></figure>


<h2 id="File-structure-and-content"><a href="#File-structure-and-content" class="headerlink" title="File structure and content"></a>File structure and content</h2><p>Let’s have an overview of the data sets using the <em>summary</em> and <em>glimpse</em> tools. First the training data:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">summary(train)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">glimpse(train)</span><br></pre></td></tr></table></figure>

<p>And then the testing data:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">summary(test)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">glimpse(test)</span><br></pre></td></tr></table></figure>

<p>We find:</p>
<ul>
<li><p><em>vendor_id</em> only takes the values 1 or 2, presumably to differentiate two taxi companies</p>
</li>
<li><p><em>pickup_datetime</em> and (in the training set) <em>dropoff_datetime</em> are combinations of date and time that we will have to re-format into a more useful shape</p>
</li>
<li><p><em>passenger_count</em> takes a median of 1 and a maximum of 9 in both data sets</p>
</li>
<li><p>The <em>pickup/dropoff_longitute/latitute</em> describes the geographical coordinates where the meter was activate/deactivated.</p>
</li>
<li><p><em>store_and_fwd_flag</em> is a flag that indicates whether the trip data was sent immediately to the vendor (“N”) or held in the memory of the taxi because there was no connection to the server (“Y”). Maybe there could be a correlation with certain geographical areas with bad reception?</p>
</li>
<li><p><em>trip_duration:</em> our target feature in the training data is measured in seconds.</p>
</li>
</ul>
<h2 id="Missing-values"><a href="#Missing-values" class="headerlink" title="Missing values"></a>Missing values</h2><p>Knowing about missing values is important because they indicate how much we don’t know about our data. Making inferences based on just a few cases is often unwise. In addition, many modelling procedures break down when missing values are involved and the corresponding rows will either have to be removed completely or the values need to be estimated somehow.</p>
<p>Here, we are in the fortunate position that our data is complete and there are no missing values:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sum(is.na(train))</span><br><span class="line">sum(is.na(test))</span><br></pre></td></tr></table></figure>

<h2 id="Combining-train-and-test"><a href="#Combining-train-and-test" class="headerlink" title="Combining train and test"></a>Combining train and test</h2><p>In preparation for our eventual modelling analysis we combine the <em>train</em> and <em>test</em> data sets into a single one. I find it generally best not to examine the <em>test</em> data too closely, since this bears the risk of overfitting your analysis to this data. However, a few simple consistency checks between the two data sets can be of advantage.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">combine &lt;- bind_rows(train %&gt;% mutate(dset &#x3D; &quot;train&quot;), </span><br><span class="line">                     test %&gt;% mutate(dset &#x3D; &quot;test&quot;,</span><br><span class="line">                                     dropoff_datetime &#x3D; NA,</span><br><span class="line">                                     trip_duration &#x3D; NA))</span><br><span class="line">combine &lt;- combine %&gt;% mutate(dset &#x3D; factor(dset))</span><br></pre></td></tr></table></figure>


<h2 id="Reformating-features"><a href="#Reformating-features" class="headerlink" title="Reformating features"></a>Reformating features</h2><p>For our following analysis, we will turn the data and time from characters into <em>date</em> objects. We also recode <em>vendor_id</em> as a factor. This makes it easier to visualise relationships that involve these features.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">train &lt;- train %&gt;%</span><br><span class="line">  mutate(pickup_datetime &#x3D; ymd_hms(pickup_datetime),</span><br><span class="line">         dropoff_datetime &#x3D; ymd_hms(dropoff_datetime),</span><br><span class="line">         vendor_id &#x3D; factor(vendor_id),</span><br><span class="line">         passenger_count &#x3D; factor(passenger_count))</span><br></pre></td></tr></table></figure>


<h2 id="Consistency-check"><a href="#Consistency-check" class="headerlink" title="Consistency check"></a>Consistency check</h2><p>It is worth checking whether the <em>trip_durations</em> are consistent with the intervals between the <em>pickup_datetime</em> and <em>dropoff_datetime</em>. Presumably the former were directly computed from the latter, but you never know. Below, the <em>check</em> variable shows “TRUE” if the two intervals are not consistent:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">train %&gt;%</span><br><span class="line">  mutate(check &#x3D; abs(int_length(interval(dropoff_datetime,pickup_datetime)) + trip_duration) &gt; 0) %&gt;%</span><br><span class="line">  select(check, pickup_datetime, dropoff_datetime, trip_duration) %&gt;%</span><br><span class="line">  group_by(check) %&gt;%</span><br><span class="line">  count()</span><br></pre></td></tr></table></figure>

<p>And we find that everything fits perfectly.</p>
<h1 id="Individual-feature-visualisations"><a href="#Individual-feature-visualisations" class="headerlink" title="Individual feature visualisations"></a>Individual feature visualisations</h1><p>Visualisations of feature distributions and their relations are key to understanding a data set, and they often open up new lines of inquiry. I always recommend to examine the data from as many different perspectives as possible to notice even subtle trends and correlations.</p>
<p>In this section we will begin by having a look at the distributions of the individual data features.</p>
<p>We start with a map of NYC and overlay a managable number of pickup coordinates to get a general overview of the locations and distances in question. For this visualisation we use the <a href="https://rstudio.github.io/leaflet/" target="_blank" rel="noopener">leaflet</a> package, which includes a variety of cool tools for interactive maps. In this map you can zoom and pan through the pickup locations:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">set.seed(1234)</span><br><span class="line">foo &lt;- sample_n(train, 8e3)</span><br><span class="line"></span><br><span class="line">leaflet(data &#x3D; foo) %&gt;% addProviderTiles(&quot;Esri.NatGeoWorldMap&quot;) %&gt;%</span><br><span class="line">  addCircleMarkers(~ pickup_longitude, ~pickup_latitude, radius &#x3D; 1,</span><br><span class="line">                   color &#x3D; &quot;blue&quot;, fillOpacity &#x3D; 0.3)</span><br></pre></td></tr></table></figure>

<p>In turns out that almost all of our trips were in fact taking place in Manhattan only. Another notable hot-spot is JFK airport towards the south-east of the city.</p>
<p>The map gives us an idea what some of the our distributions could look like. Let’s start with plotting the target feature <em>trip_duration</em>:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">train %&gt;%</span><br><span class="line">  ggplot(aes(trip_duration)) +</span><br><span class="line">  geom_histogram(fill &#x3D; &quot;red&quot;, bins &#x3D; 150) +</span><br><span class="line">  scale_x_log10() +</span><br><span class="line">  scale_y_sqrt()</span><br></pre></td></tr></table></figure>

<p>Note the logarithmic x-axis and square-root y-axis.</p>
<p>We find:</p>
<ul>
<li><p>the majority of rides follow a rather smooth distribution that looks almost log-normal with a peak just short of 1000 seconds, i.e. about 17 minutes.</p>
</li>
<li><p>There are several suspiciously short rides with less than 10 seconds duration.</p>
</li>
<li><p>Additionally, there is a strange delta-shaped peak of <em>trip_duration</em> just before the 1e5 seconds mark and even a few way above it:</p>
</li>
</ul>
<figure class="highlight plain"><figcaption><span>warning </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">train %&gt;%</span><br><span class="line">  arrange(desc(trip_duration)) %&gt;%</span><br><span class="line">  select(trip_duration, pickup_datetime, dropoff_datetime, everything()) %&gt;%</span><br><span class="line">  head(10)</span><br></pre></td></tr></table></figure>

<p>Those records would correspond to 24-hour trips and beyond, with a maximum of almost 12 days. I know that rush hour can be bad, but those values are a little unbelievable.</p>
<p>Over the year, the distributions of <em>pickup_datetime</em> and <em>dropoff_datetime</em> look like this:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">p1 &lt;- train %&gt;%</span><br><span class="line">  ggplot(aes(pickup_datetime)) +</span><br><span class="line">  geom_histogram(fill &#x3D; &quot;red&quot;, bins &#x3D; 120) +</span><br><span class="line">  labs(x &#x3D; &quot;Pickup dates&quot;)</span><br><span class="line"></span><br><span class="line">p2 &lt;- train %&gt;%</span><br><span class="line">  ggplot(aes(dropoff_datetime)) +</span><br><span class="line">  geom_histogram(fill &#x3D; &quot;blue&quot;, bins &#x3D; 120) +</span><br><span class="line">  labs(x &#x3D; &quot;Dropoff dates&quot;)</span><br><span class="line"></span><br><span class="line">layout &lt;- matrix(c(1,2),2,1,byrow&#x3D;FALSE)</span><br><span class="line">multiplot(p1, p2, layout&#x3D;layout)</span><br><span class="line">p1 &lt;- 1; p2 &lt;- 1</span><br></pre></td></tr></table></figure>

<p>Fairly homogeneous, covering half a year between January and July 2016. There is an interesting drop around late January early February:</p>
<figure class="highlight plain"><figcaption><span>eval</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">train %&gt;%</span><br><span class="line">  filter(pickup_datetime &gt; ymd(&quot;2016-01-20&quot;) &amp; pickup_datetime &lt; ymd(&quot;2016-02-10&quot;)) %&gt;%</span><br><span class="line">  ggplot(aes(pickup_datetime)) +</span><br><span class="line">  geom_histogram(fill &#x3D; &quot;red&quot;, bins &#x3D; 120)</span><br></pre></td></tr></table></figure>

<p>That’s winter in NYC, so maybe snow storms or other heavy weather? Events like this should be taken into account, maybe through some handy external data set?</p>
<p>In the plot above we can already see some daily and weekly modulations in the number of trips. Let’s investigate these variations together with the distributions of <em>passenger_count</em> and <em>vendor_id</em> by creating a multi-plot panel with different components:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">p1 &lt;- train %&gt;%</span><br><span class="line">  group_by(passenger_count) %&gt;%</span><br><span class="line">  count() %&gt;%</span><br><span class="line">  ggplot(aes(passenger_count, n, fill &#x3D; passenger_count)) +</span><br><span class="line">  geom_col() +</span><br><span class="line">  scale_y_sqrt() +</span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line">p2 &lt;- train %&gt;%</span><br><span class="line">  ggplot(aes(vendor_id, fill &#x3D; vendor_id)) +</span><br><span class="line">  geom_bar() +</span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line">p3 &lt;- train %&gt;%</span><br><span class="line">  ggplot(aes(store_and_fwd_flag)) +</span><br><span class="line">  geom_bar() +</span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;) +</span><br><span class="line">  scale_y_log10()</span><br><span class="line"></span><br><span class="line">p4 &lt;- train %&gt;%</span><br><span class="line">  mutate(wday &#x3D; wday(pickup_datetime, label &#x3D; TRUE)) %&gt;%</span><br><span class="line">  group_by(wday, vendor_id) %&gt;%</span><br><span class="line">  count() %&gt;%</span><br><span class="line">  ggplot(aes(wday, n, colour &#x3D; vendor_id)) +</span><br><span class="line">  geom_point(size &#x3D; 4) +</span><br><span class="line">  labs(x &#x3D; &quot;Day of the week&quot;, y &#x3D; &quot;Total number of pickups&quot;) +</span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line">p5 &lt;- train %&gt;%</span><br><span class="line">  mutate(hpick &#x3D; hour(pickup_datetime)) %&gt;%</span><br><span class="line">  group_by(hpick, vendor_id) %&gt;%</span><br><span class="line">  count() %&gt;%</span><br><span class="line">  ggplot(aes(hpick, n, color &#x3D; vendor_id)) +</span><br><span class="line">  geom_point(size &#x3D; 4) +</span><br><span class="line">  labs(x &#x3D; &quot;Hour of the day&quot;, y &#x3D; &quot;Total number of pickups&quot;) +</span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line">layout &lt;- matrix(c(1,2,3,4,5,5),3,2,byrow&#x3D;TRUE)</span><br><span class="line">multiplot(p1, p2, p3, p4, p5, layout&#x3D;layout)</span><br><span class="line">p1 &lt;- 1; p2 &lt;- 1; p3 &lt;- 1; p4 &lt;- 1; p5 &lt;- 1</span><br></pre></td></tr></table></figure>

<p>We find:</p>
<ul>
<li>There are a few trips with zero, or seven to nine passengers but they are a rare exception:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">train %&gt;%</span><br><span class="line">  group_by(passenger_count) %&gt;%</span><br><span class="line">  count()</span><br></pre></td></tr></table></figure>

<ul>
<li><p>The vast majority of rides had only a single passenger, with two passengers being the (distant) second most popular option.</p>
</li>
<li><p>Towards larger passenger numbers we are seeing a smooth decline through 3 to 4, until the larger crowds (and larger cars) give us another peak at 5 to 6 passengers.</p>
</li>
<li><p>Vendor 2 has significantly more trips in this data set than vendor 1 (note the logarithmic y-axis). This is true for every day of the week.</p>
</li>
<li><p>We find an interesting pattern with Monday being the quietest day and Friday very busy. This is the same for the two different vendors, with <em>vendor_id == 2</em> showing significantly higher trip numbers.</p>
</li>
<li><p>As one would intuitively expect, there is a strong dip during the early morning hours. There we also see not much difference between the two vendors. We find another dip around 4pm and then the numbers increase towards the evening.</p>
</li>
<li><p>The <em>store_and_fwd_flag</em> values, indicating whether the trip data was sent immediately to the vendor (“N”) or held in the memory of the taxi because there was no connection to the server (“Y”), show that there was almost no storing taking place (note again the logarithmic y-axis):</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">train %&gt;%</span><br><span class="line">  group_by(store_and_fwd_flag) %&gt;%</span><br><span class="line">  count()</span><br></pre></td></tr></table></figure>

<p>These numbers are equivalent to about half a percent of trips not being transmitted immediately.</p>
<p>The trip volume per hour of the day depends somewhat on the month and strongly on the day of the week:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">p1 &lt;- train %&gt;%</span><br><span class="line">  mutate(hpick &#x3D; hour(pickup_datetime),</span><br><span class="line">         Month &#x3D; factor(month(pickup_datetime, label &#x3D; TRUE))) %&gt;%</span><br><span class="line">  group_by(hpick, Month) %&gt;%</span><br><span class="line">  count() %&gt;%</span><br><span class="line">  ggplot(aes(hpick, n, color &#x3D; Month)) +</span><br><span class="line">  geom_line(size &#x3D; 1.5) +</span><br><span class="line">  labs(x &#x3D; &quot;Hour of the day&quot;, y &#x3D; &quot;count&quot;)</span><br><span class="line"></span><br><span class="line">p2 &lt;- train %&gt;%</span><br><span class="line">  mutate(hpick &#x3D; hour(pickup_datetime),</span><br><span class="line">         wday &#x3D; factor(wday(pickup_datetime, label &#x3D; TRUE))) %&gt;%</span><br><span class="line">  group_by(hpick, wday) %&gt;%</span><br><span class="line">  count() %&gt;%</span><br><span class="line">  ggplot(aes(hpick, n, color &#x3D; wday)) +</span><br><span class="line">  geom_line(size &#x3D; 1.5) +</span><br><span class="line">  labs(x &#x3D; &quot;Hour of the day&quot;, y &#x3D; &quot;count&quot;)</span><br><span class="line"></span><br><span class="line">layout &lt;- matrix(c(1,2),2,1,byrow&#x3D;FALSE)</span><br><span class="line">multiplot(p1, p2, layout&#x3D;layout)</span><br><span class="line">p1 &lt;- 1; p2 &lt;- 1</span><br></pre></td></tr></table></figure>

<p>We find:</p>
<ul>
<li><p>January and June have fewer trips, whereas March and April are busier months. This tendency is observed for both <em>vendor_ids</em>.</p>
</li>
<li><p>The weekend (Sat and Sun, plus Fri to an extend) have higher trip numbers during the early morning ours but lower ones in the morning between 5 and 10, which can most likely be attributed to the contrast between NYC business days and weekend night life. In addition, trip numbers drop on a Sunday evening/night.</p>
</li>
</ul>
<p>Finally, we will look at a simple overview visualisation of the <em>pickup/dropoff</em> latitudes and longitudes:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">p1 &lt;- train %&gt;%</span><br><span class="line">  filter(pickup_longitude &gt; -74.05 &amp; pickup_longitude &lt; -73.7) %&gt;%</span><br><span class="line">  ggplot(aes(pickup_longitude)) +</span><br><span class="line">  geom_histogram(fill &#x3D; &quot;red&quot;, bins &#x3D; 40)</span><br><span class="line"></span><br><span class="line">p2 &lt;- train %&gt;%</span><br><span class="line">  filter(dropoff_longitude &gt; -74.05 &amp; dropoff_longitude &lt; -73.7) %&gt;%</span><br><span class="line">  ggplot(aes(dropoff_longitude)) +</span><br><span class="line">  geom_histogram(fill &#x3D; &quot;blue&quot;, bins &#x3D; 40)</span><br><span class="line"></span><br><span class="line">p3 &lt;- train %&gt;%</span><br><span class="line">  filter(pickup_latitude &gt; 40.6 &amp; pickup_latitude &lt; 40.9) %&gt;%</span><br><span class="line">  ggplot(aes(pickup_latitude)) +</span><br><span class="line">  geom_histogram(fill &#x3D; &quot;red&quot;, bins &#x3D; 40)</span><br><span class="line"></span><br><span class="line">p4 &lt;- train %&gt;%</span><br><span class="line">  filter(dropoff_latitude &gt; 40.6 &amp; dropoff_latitude &lt; 40.9) %&gt;%</span><br><span class="line">  ggplot(aes(dropoff_latitude)) +</span><br><span class="line">  geom_histogram(fill &#x3D; &quot;blue&quot;, bins &#x3D; 40)</span><br><span class="line"></span><br><span class="line">layout &lt;- matrix(c(1,2,3,4),2,2,byrow&#x3D;FALSE)</span><br><span class="line">multiplot(p1, p2, p3, p4, layout&#x3D;layout)</span><br><span class="line">p1 &lt;- 1; p2 &lt;- 1; p3 &lt;- 1; p4 &lt;- 1</span><br></pre></td></tr></table></figure>

<p>Here we had to constrain the range of latitude and longitude values, because there are a few cases which are way outside the NYC boundaries. The resulting distributions are consistent with the focus on Manhattan that we had already seen on the map. These are the most extreme values from the <em>pickup_latitude</em> feature:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">train %&gt;%</span><br><span class="line">  arrange(pickup_latitude) %&gt;%</span><br><span class="line">  select(pickup_latitude, pickup_longitude) %&gt;%</span><br><span class="line">  head(5)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">train %&gt;%</span><br><span class="line">  arrange(desc(pickup_latitude)) %&gt;%</span><br><span class="line">  select(pickup_latitude, pickup_longitude) %&gt;%</span><br><span class="line">  head(5)</span><br></pre></td></tr></table></figure>

<p>We need to keep the existence of these (rather astonishing) values in mind so that they don’t bias our analysis.</p>
<h1 id="Feature-relations"><a href="#Feature-relations" class="headerlink" title="Feature relations"></a>Feature relations</h1><p>While the previous section looked primarily at the distributions of the individual features, here we will examine in more detail how those features are related to each other and to our target <em>trip_duration</em>.</p>
<h2 id="Pickup-date-time-vs-trip-duration"><a href="#Pickup-date-time-vs-trip-duration" class="headerlink" title="Pickup date/time vs trip_duration"></a>Pickup date/time vs <em>trip_duration</em></h2><p>How does the variation in trip numbers throughout the day and the week affect the average trip duration? Do quieter days and hours lead to faster trips? Here we include the <em>vendor_id</em> as an additional feature. Furthermore, for the hours of the day we add a smoothing layer to indicate the extent of the variation and its uncertainties:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">p1 &lt;- train %&gt;%</span><br><span class="line">  mutate(wday &#x3D; wday(pickup_datetime, label &#x3D; TRUE)) %&gt;%</span><br><span class="line">  group_by(wday, vendor_id) %&gt;%</span><br><span class="line">  summarise(median_duration &#x3D; median(trip_duration)&#x2F;60) %&gt;%</span><br><span class="line">  ggplot(aes(wday, median_duration, color &#x3D; vendor_id)) +</span><br><span class="line">  geom_point(size &#x3D; 4) +</span><br><span class="line">  labs(x &#x3D; &quot;Day of the week&quot;, y &#x3D; &quot;Median trip duration [min]&quot;)</span><br><span class="line"></span><br><span class="line">p2 &lt;- train %&gt;%</span><br><span class="line">  mutate(hpick &#x3D; hour(pickup_datetime)) %&gt;%</span><br><span class="line">  group_by(hpick, vendor_id) %&gt;%</span><br><span class="line">  summarise(median_duration &#x3D; median(trip_duration)&#x2F;60) %&gt;%</span><br><span class="line">  ggplot(aes(hpick, median_duration, color &#x3D; vendor_id)) +</span><br><span class="line">  geom_smooth(method &#x3D; &quot;loess&quot;, span &#x3D; 1&#x2F;2) +</span><br><span class="line">  geom_point(size &#x3D; 4) +</span><br><span class="line">  labs(x &#x3D; &quot;Hour of the day&quot;, y &#x3D; &quot;Median trip duration [min]&quot;) +</span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line">layout &lt;- matrix(c(1,2),2,1,byrow&#x3D;FALSE)</span><br><span class="line">multiplot(p1, p2, layout&#x3D;layout)</span><br><span class="line">p1 &lt;- 1; p2 &lt;- 1</span><br></pre></td></tr></table></figure>

<p>We find:</p>
<ul>
<li><p>There is indeed a similar pattern as for the business of the day of the week. Vendor 2, the one with the more frequent trips, also has consistently higher trip durations than vendor 1. <strong>It will be worth adding the <em>vendor_id</em> feature to a model to test its predictive importance.</strong></p>
</li>
<li><p>Over the course of a typical day we find a peak in the early afternoon and dips around 5-6am and 8pm. <strong>The weekday and hour of a trip appear to be important features for predicting its duration and should be included in a successful model.</strong></p>
</li>
</ul>
<h2 id="Passenger-count-and-Vendor-vs-trip-duration"><a href="#Passenger-count-and-Vendor-vs-trip-duration" class="headerlink" title="Passenger count and Vendor vs trip_duration"></a>Passenger count and Vendor vs <em>trip_duration</em></h2><p>The next question we are asking is whether different numbers of passengers and/or the different vendors are correlated with the duration of the trip. We choose to examine this issue using a series of boxplots for the <em>passenger_counts</em> together with a <em>facet wrap</em> which contrasts the two <em>vendor_ids</em>: </p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">train %&gt;%</span><br><span class="line">  ggplot(aes(passenger_count, trip_duration, color &#x3D; passenger_count)) +</span><br><span class="line">  geom_boxplot() +</span><br><span class="line">  scale_y_log10() +</span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;) +</span><br><span class="line">  facet_wrap(~ vendor_id) +</span><br><span class="line">  labs(y &#x3D; &quot;Trip duration [s]&quot;, x &#x3D; &quot;Number of passengers&quot;)</span><br></pre></td></tr></table></figure>

<p>We find:</p>
<ul>
<li><p>Both vendors have short trips without any passengers.</p>
</li>
<li><p>Vendor 1 has all of the trips beyond 24 hours, whereas vendor 2 has all of the (five) trips with more than six passengers and many more trips that approach the 24-hour limit.</p>
</li>
<li><p>Between 1 and 6 passengers the median trip durations are remarkably similar, in particular for vendor 2. There might be differences for vendor 1, but they are small (note the logarithmic y-axis):</p>
</li>
</ul>
<figure class="highlight plain"><figcaption><span>eval</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">train %&gt;%</span><br><span class="line">  ggplot(aes(trip_duration, fill &#x3D; vendor_id)) +</span><br><span class="line">  geom_density(position &#x3D; &quot;stack&quot;) +</span><br><span class="line">  scale_x_log10()</span><br></pre></td></tr></table></figure>

<p>Comparing the densities of the <em>trip_duration</em> distribution for the two vendors we find that the medians are very similar, whereas the means are likely skewed by vendor 2 containing most of the long-duration outliers:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">train %&gt;%</span><br><span class="line">  group_by(vendor_id) %&gt;%</span><br><span class="line">  summarise(mean_duration &#x3D; mean(trip_duration),</span><br><span class="line">            median_duration &#x3D; median(trip_duration))</span><br></pre></td></tr></table></figure>





<h2 id="Store-and-Forward-vs-trip-duration"><a href="#Store-and-Forward-vs-trip-duration" class="headerlink" title="Store and Forward vs trip_duration"></a>Store and Forward vs <em>trip_duration</em></h2><p>The temporary storing of the trip data only occured for Vendor 1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">train %&gt;%</span><br><span class="line"></span><br><span class="line">  group_by(vendor_id, store_and_fwd_flag) %&gt;%</span><br><span class="line"></span><br><span class="line">  count()</span><br></pre></td></tr></table></figure>





<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(vendor_id &#x3D;&#x3D; 1) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(passenger_count, trip_duration, color &#x3D; passenger_count)) +</span><br><span class="line"></span><br><span class="line">  geom_boxplot() +</span><br><span class="line"></span><br><span class="line">  scale_y_log10() +</span><br><span class="line"></span><br><span class="line">  facet_wrap(~ store_and_fwd_flag) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;) +</span><br><span class="line"></span><br><span class="line">  labs(y &#x3D; &quot;Trip duration [s]&quot;, x &#x3D; &quot;Number of passengers&quot;) +</span><br><span class="line"></span><br><span class="line">  ggtitle(&quot;Store_and_fwd_flag impact&quot;)</span><br></pre></td></tr></table></figure>



<p>We find that there is no overwhelming differences between the stored and non-stored trips. The stored ones might be slightly longer, though, and don’t include any of the suspiciously long trips.</p>
<h1 id="Feature-engineering"><a href="#Feature-engineering" class="headerlink" title="Feature engineering"></a>Feature engineering</h1><p>In this section we build new features from the existing ones, trying to find better predictors for our target variable. I prefer to define all these new features in a single code block below and then study them in the following subsections. This does not correspond to a linear analysis but it makes the notebook more readable and ensures that we don’t miss any stray feature definitions.</p>
<p>The new temporal features (date, month, wday, hour) are derived from the <em>pickup_datetime</em>. We got the JFK and La Guardia airport coordinates from Wikipedia. The <em>blizzard</em> feature is based on the external weather data.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">jfk_coord &lt;- tibble(lon &#x3D; -73.778889, lat &#x3D; 40.639722)</span><br><span class="line"></span><br><span class="line">la_guardia_coord &lt;- tibble(lon &#x3D; -73.872611, lat &#x3D; 40.77725)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pick_coord &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  select(pickup_longitude, pickup_latitude)</span><br><span class="line"></span><br><span class="line">drop_coord &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  select(dropoff_longitude, dropoff_latitude)</span><br><span class="line"></span><br><span class="line">train$dist &lt;- distCosine(pick_coord, drop_coord)</span><br><span class="line"></span><br><span class="line">train$bearing &#x3D; bearing(pick_coord, drop_coord)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">train$jfk_dist_pick &lt;- distCosine(pick_coord, jfk_coord)</span><br><span class="line"></span><br><span class="line">train$jfk_dist_drop &lt;- distCosine(drop_coord, jfk_coord)</span><br><span class="line"></span><br><span class="line">train$lg_dist_pick &lt;- distCosine(pick_coord, la_guardia_coord)</span><br><span class="line"></span><br><span class="line">train$lg_dist_drop &lt;- distCosine(drop_coord, la_guardia_coord)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">train &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  mutate(speed &#x3D; dist&#x2F;trip_duration*3.6,</span><br><span class="line"></span><br><span class="line">         date &#x3D; date(pickup_datetime),</span><br><span class="line"></span><br><span class="line">         month &#x3D; month(pickup_datetime, label &#x3D; TRUE),</span><br><span class="line"></span><br><span class="line">         wday &#x3D; wday(pickup_datetime, label &#x3D; TRUE),</span><br><span class="line"></span><br><span class="line">         wday &#x3D; fct_relevel(wday, c(&quot;Mon&quot;, &quot;Tues&quot;, &quot;Wed&quot;, &quot;Thurs&quot;, &quot;Fri&quot;, &quot;Sat&quot;, &quot;Sun&quot;)),</span><br><span class="line"></span><br><span class="line">         hour &#x3D; hour(pickup_datetime),</span><br><span class="line"></span><br><span class="line">         work &#x3D; (hour %in% seq(8,18)) &amp; (wday %in% c(&quot;Mon&quot;,&quot;Tues&quot;,&quot;Wed&quot;,&quot;Thurs&quot;,&quot;Fri&quot;)),</span><br><span class="line"></span><br><span class="line">         jfk_trip &#x3D; (jfk_dist_pick &lt; 2e3) | (jfk_dist_drop &lt; 2e3),</span><br><span class="line"></span><br><span class="line">         lg_trip &#x3D; (lg_dist_pick &lt; 2e3) | (lg_dist_drop &lt; 2e3),</span><br><span class="line"></span><br><span class="line">         blizzard &#x3D; !( (date &lt; ymd(&quot;2016-01-22&quot;) | (date &gt; ymd(&quot;2016-01-29&quot;))) )</span><br><span class="line"></span><br><span class="line">         )</span><br></pre></td></tr></table></figure>





<h2 id="Direct-distance-of-the-trip"><a href="#Direct-distance-of-the-trip" class="headerlink" title="Direct distance of the trip"></a>Direct distance of the trip</h2><p>From the coordinates of the pickup and dropoff points we can calculate the direct <em>distance</em> (as the crow flies) between the two points, and compare it to our <em>trip_durations</em>. Since taxis aren’t crows (in most practical scenarios), these values correspond to the minimum possible travel distance. </p>
<p>To compute these distances we are using the <em>distCosine</em> function of the <a href="https://cran.r-project.org/web/packages/geosphere/index.html" target="_blank" rel="noopener">geosphere</a> package for spherical trigonometry. This method gives us the shortest distance between two points on a spherical earth. For the purpose of this localised analysis we choose to ignore ellipsoidal distortion of the earth’s shape. Here are the raw values of distance vs duration (based on a down-sized sample to speed up the kernel).</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">set.seed(4321)</span><br><span class="line"></span><br><span class="line">train %&gt;%</span><br><span class="line"></span><br><span class="line">  sample_n(5e4) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(dist, trip_duration)) +</span><br><span class="line"></span><br><span class="line">  geom_point() +</span><br><span class="line"></span><br><span class="line">  scale_x_log10() +</span><br><span class="line"></span><br><span class="line">  scale_y_log10() +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Direct distance [m]&quot;, y &#x3D; &quot;Trip duration [s]&quot;)</span><br></pre></td></tr></table></figure>



<p>We find:</p>
<ul>
<li>The distance generally increases with increasing <em>trip_duration</em></li>
</ul>
<ul>
<li>Here, the 24-hour trips look even more suspicious and are even more likely to be artefacts in the data.</li>
</ul>
<ul>
<li>In addition, there are number of trips with very short distances, down to 1 metre, but with a large range of apparent <em>trip_durations</em></li>
</ul>
<p>Let’s filter the data a little bit to remove the extreme (and the extremely suspicious) data points, and bin the data into a 2-d histogram. This plot shows that in log-log space the <em>trip_duration</em> is increasing slower than linear for larger <em>dist</em>ance values:</p>
<figure class="highlight plain"><figcaption><span>eval</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(trip_duration &lt; 3600 &amp; trip_duration &gt; 120) %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(dist &gt; 100 &amp; dist &lt; 100e3) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(dist, trip_duration)) +</span><br><span class="line"></span><br><span class="line">  geom_bin2d(bins &#x3D; c(500,500)) +</span><br><span class="line"></span><br><span class="line">  scale_x_log10() +</span><br><span class="line"></span><br><span class="line">  scale_y_log10() +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Direct distance [m]&quot;, y &#x3D; &quot;Trip duration [s]&quot;)</span><br></pre></td></tr></table></figure>





<h2 id="Travel-speed"><a href="#Travel-speed" class="headerlink" title="Travel speed"></a>Travel speed</h2><p>Distance over time is of course velocity, and by computing the average apparent velocity of our taxis we will have another diagnostic to remove bogus values. Of course, we won’t be able to use <em>speed</em> as a predictor for our model, since it requires knowing the travel time, but it can still be helpful in cleaning up our training data and finding other features with predictive power. This is the <em>speed</em> distribution:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(speed &gt; 2 &amp; speed &lt; 1e2) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(speed)) +</span><br><span class="line"></span><br><span class="line">  geom_histogram(fill &#x3D; &quot;red&quot;, bins &#x3D; 50) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Average speed [km&#x2F;h] (direct distance)&quot;)</span><br></pre></td></tr></table></figure>



<p>Well, after removing the most extreme values this looks way better than I would have expected. An average speed of around 15 km/h sounds probably reasonable for NYC. Everything above 50 km/h certainly requires magical cars (or highway travel). Also keep in mind that this refers to the direct distance and that the real velocity would have been always higher.</p>
<p>In a similar way as the average duration per day and hour we can also investigate the average speed for these time bins:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">p1 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  group_by(wday, vendor_id) %&gt;%</span><br><span class="line"></span><br><span class="line">  summarise(median_speed &#x3D; median(speed)) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(wday, median_speed, color &#x3D; vendor_id)) +</span><br><span class="line"></span><br><span class="line">  geom_point(size &#x3D; 4) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Day of the week&quot;, y &#x3D; &quot;Median speed [km&#x2F;h]&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p2 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  group_by(hour, vendor_id) %&gt;%</span><br><span class="line"></span><br><span class="line">  summarise(median_speed &#x3D; median(speed)) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(hour, median_speed, color &#x3D; vendor_id)) +</span><br><span class="line"></span><br><span class="line">  geom_smooth(method &#x3D; &quot;loess&quot;, span &#x3D; 1&#x2F;2) +</span><br><span class="line"></span><br><span class="line">  geom_point(size &#x3D; 4) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Hour of the day&quot;, y &#x3D; &quot;Median speed [km&#x2F;h]&quot;) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p3 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  group_by(wday, hour) %&gt;%</span><br><span class="line"></span><br><span class="line">  summarise(median_speed &#x3D; median(speed)) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(hour, wday, fill &#x3D; median_speed)) +</span><br><span class="line"></span><br><span class="line">  geom_tile() +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Hour of the day&quot;, y &#x3D; &quot;Day of the week&quot;) +</span><br><span class="line"></span><br><span class="line">  scale_fill_distiller(palette &#x3D; &quot;Spectral&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">layout &lt;- matrix(c(1,2,3,3),2,2,byrow&#x3D;TRUE)</span><br><span class="line"></span><br><span class="line">multiplot(p1, p2, p3, layout&#x3D;layout)</span><br><span class="line"></span><br><span class="line">p1 &lt;- 1; p2 &lt;- 1; p3 &lt;- 1</span><br></pre></td></tr></table></figure>



<p>We find:</p>
<ul>
<li>Our taxis appear to be travelling faster on the weekend and on a Monday than during the rest of the week.</li>
</ul>
<ul>
<li>The early morning hours allow for a speedier trip, with everything from 8am to 6pm being similarly slow.</li>
</ul>
<ul>
<li>There are almost no differences between the two vendors.</li>
</ul>
<ul>
<li>The heatmap in the lower panel visualises how these trends combine to create a “low-speed-zone” in the middle of the day and week. <strong>Based on this, we create a new feature <em>work</em>, which we define as 8am-6pm on Mon-Fri.</strong></li>
</ul>
<h2 id="Bearing-direction"><a href="#Bearing-direction" class="headerlink" title="Bearing direction"></a>Bearing direction</h2><p>If the direct <em>distance</em> is the magnitude of the trip vector then the <em>bearing</em> is its (initial) direction. Easily estimated through the <em>geosphere</em> package, it tells us whether our trip started out for instance in the direction of North-West or South-East. Here we visualise the <em>bearing</em> distribution and its relation to <em>trip_duration</em>, direct <em>distance</em>, and <em>speed</em>:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">p1 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(dist &lt; 1e5) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(bearing)) +</span><br><span class="line"></span><br><span class="line">  geom_histogram(fill &#x3D; &quot;red&quot;, bins &#x3D; 75) +</span><br><span class="line"></span><br><span class="line">  scale_x_continuous(breaks &#x3D; seq(-180, 180, by &#x3D; 45)) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Bearing&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p2 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(dist &lt; 1e5) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(bearing, dist)) +</span><br><span class="line"></span><br><span class="line">  geom_bin2d(bins &#x3D; c(100,100)) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Bearing&quot;, y &#x3D; &quot;Direct distance&quot;) +</span><br><span class="line"></span><br><span class="line">  scale_y_log10() +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;) +</span><br><span class="line"></span><br><span class="line">  coord_polar() +</span><br><span class="line"></span><br><span class="line">  scale_x_continuous(breaks &#x3D; seq(-180, 180, by &#x3D; 45))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p3 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(trip_duration &lt; 3600*22) %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(dist &lt; 1e5) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(bearing, trip_duration)) +</span><br><span class="line"></span><br><span class="line">  geom_bin2d(bins &#x3D; c(100,100)) +</span><br><span class="line"></span><br><span class="line">  scale_y_log10() +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Bearing&quot;, y &#x3D; &quot;Trip duration&quot;) +</span><br><span class="line"></span><br><span class="line">  coord_polar() +</span><br><span class="line"></span><br><span class="line">  scale_x_continuous(breaks &#x3D; seq(-180, 180, by &#x3D; 45))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p4 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(speed &lt; 75 &amp; dist &lt; 1e5) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(bearing, speed)) +</span><br><span class="line"></span><br><span class="line">  geom_bin2d(bins &#x3D; c(100,100)) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Bearing&quot;, y &#x3D; &quot;Speed&quot;) +</span><br><span class="line"></span><br><span class="line">  coord_polar() +</span><br><span class="line"></span><br><span class="line">  scale_x_continuous(breaks &#x3D; seq(-180, 180, by &#x3D; 45))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">layout &lt;- matrix(c(1,2,3,4),2,2,byrow&#x3D;TRUE)</span><br><span class="line"></span><br><span class="line">multiplot(p1, p2, p3, p4, layout&#x3D;layout)</span><br><span class="line"></span><br><span class="line">p1 &lt;- 1; p2 &lt;- 1; p3 &lt;- 1; p4 &lt;- 1</span><br></pre></td></tr></table></figure>



<p>This is one of the few cases where polar coordinates might be actually helpful. (Ignore the small discontinuities caused by the binning.)</p>
<p>We find:</p>
<ul>
<li>The <em>bearing</em> direction has two prominent peaks around 30 and -150 degrees. Intuitively, those might relate to the orientation of Manhattan. Three or four smaller, less sharp peaks are visible in between those larger peaks.</li>
</ul>
<ul>
<li>The 2-d histograms of <em>distance</em> and <em>trip_duration</em> don’t reveal much structure. There are indications for shorter durations and distances at the two peaks, but those might simply be caused by the larger number of observations in these peaks. Faint clusters towards higher <em>trip_durations</em> might be visible near -60 and 125 degrees <em>bearing</em>.</li>
</ul>
<ul>
<li>The bright “rings” we see in the <em>distance</em> and <em>trip_duration</em> reflect the familiar distribution peaks on the logarithmic scale.</li>
</ul>
<ul>
<li><em>Speed</em>, on the other hand, shows an interestingly clustered structure along the <em>bearing</em> directions. Zones of higher speed can be identified at the aforementioned <em>bearing</em> peaks as well roughly perpendicular to them (most prominently around 125 degrees). It is possible that we are seeing the Manhattan street grid in this data. Note, that here the radial scale is not logarithmic.</li>
</ul>
<h2 id="Airport-distance"><a href="#Airport-distance" class="headerlink" title="Airport distance"></a>Airport distance</h2><p>In our maps (above) and trip paths (below) we noticed that a number of trips began or ended at either of the two NYC airports: JFK and La Guardia. Since airports are usually not in the city centre it is reasonable to assume that the pickup/dropoff distance from the airport could be a useful predictor for longer <em>trip_durations</em>. Above, we defined the coordinates of the two airports and compute the corresponding distances:</p>
<figure class="highlight plain"><figcaption><span>eval</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">p1 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(jfk_dist_pick)) +</span><br><span class="line"></span><br><span class="line">  geom_histogram(bins &#x3D; 30, fill &#x3D; &quot;red&quot;) +</span><br><span class="line"></span><br><span class="line">  scale_x_log10() +</span><br><span class="line"></span><br><span class="line">  scale_y_sqrt() +</span><br><span class="line"></span><br><span class="line">  geom_vline(xintercept &#x3D; 2e3) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;JFK pickup distance&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p2 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(jfk_dist_drop)) +</span><br><span class="line"></span><br><span class="line">  geom_histogram(bins &#x3D; 30, fill &#x3D; &quot;blue&quot;) +</span><br><span class="line"></span><br><span class="line">  scale_x_log10() +</span><br><span class="line"></span><br><span class="line">  scale_y_sqrt() +</span><br><span class="line"></span><br><span class="line">  geom_vline(xintercept &#x3D; 2e3) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;JFK dropoff distance&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p3 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(lg_dist_pick)) +</span><br><span class="line"></span><br><span class="line">  geom_histogram(bins &#x3D; 30, fill &#x3D; &quot;red&quot;) +</span><br><span class="line"></span><br><span class="line">  scale_x_log10() +</span><br><span class="line"></span><br><span class="line">  scale_y_sqrt() +</span><br><span class="line"></span><br><span class="line">  geom_vline(xintercept &#x3D; 2e3) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;La Guardia pickup distance&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p4 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(lg_dist_drop)) +</span><br><span class="line"></span><br><span class="line">  geom_histogram(bins &#x3D; 30, fill &#x3D; &quot;blue&quot;) +</span><br><span class="line"></span><br><span class="line">  scale_x_log10() +</span><br><span class="line"></span><br><span class="line">  scale_y_sqrt() +</span><br><span class="line"></span><br><span class="line">  geom_vline(xintercept &#x3D; 2e3) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;La Guardia dropoff distance&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">layout &lt;- matrix(c(1,2,3,4),2,2,byrow&#x3D;FALSE)</span><br><span class="line"></span><br><span class="line">multiplot(p1, p2, p3, p4, layout&#x3D;layout)</span><br><span class="line"></span><br><span class="line">p1 &lt;- 1; p2 &lt;- 1; p3 &lt;- 1; p4 &lt;- 1; p5 &lt;- 1</span><br></pre></td></tr></table></figure>





<p>Based on these numbers, we can define a JFK/La Guardia trip as having a pickup or dropoff distance of less than 2 km from the corresponding airport.</p>
<p>What are the <em>trip_durations</em> of these journeys?</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">p1 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(trip_duration &lt; 23*3600) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(jfk_trip, trip_duration, color &#x3D; jfk_trip)) +</span><br><span class="line"></span><br><span class="line">  geom_boxplot() +</span><br><span class="line"></span><br><span class="line">  scale_y_log10() +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;JFK trip&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p2 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(trip_duration &lt; 23*3600) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(lg_trip, trip_duration, color &#x3D; lg_trip)) +</span><br><span class="line"></span><br><span class="line">  geom_boxplot() +</span><br><span class="line"></span><br><span class="line">  scale_y_log10() +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;La Guardia trip&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">layout &lt;- matrix(c(1,2),1,2,byrow&#x3D;FALSE)</span><br><span class="line"></span><br><span class="line">multiplot(p1, p2, layout&#x3D;layout)</span><br><span class="line"></span><br><span class="line">p1 &lt;- 1; p2 &lt;- 1</span><br></pre></td></tr></table></figure>



<p>We find that our hypothesis was correct and that trips to the airport, in particular the more distant JFK, have significantly longer average <em>trip_durations</em>. <strong>These two features should definitely be part of our model.</strong></p>
<h1 id="Data-cleaning"><a href="#Data-cleaning" class="headerlink" title="Data cleaning"></a>Data cleaning</h1><p>Before we turn to the modelling it is time to clean up our training data. We have waited to do this until now to have a more complete overview of the problematic observations. The aim here is to remove trips that have improbable features, such as extreme trip durations or very low average speed.</p>
<p>While there might also be a number of bogus trip durations in the test data we shouldn’t be able to predict them in any case (unless there were some real correlations). By removing these training data values we will make our model more robust and more likely to generalise to unseen data, which is always our primary goal in machine learning.</p>
<h2 id="Extreme-trip-durations"><a href="#Extreme-trip-durations" class="headerlink" title="Extreme trip durations"></a>Extreme trip durations</h2><p>Let’s visualise the distances of the trips that took a day or longer. Unless someone took a taxi from NYC to LA it is unlikely that those values are accurate. Here we make use of the <em>maps</em> package to draw an outline of Manhattan, where most of the trips begin or end. We then overlay the pickup coordinates in red, and the dropoff coordinates in blue.</p>
<p>To further add the trip connections (direct distance) we use another handy tool from the <em>geosphere</em> package: <em>gcIntermediate</em> allows us to interpolate the path between two sets of coordinates. I’ve seen this tool first in action in this <a href="https://www.kaggle.com/jonathanbouchet/u-s-commercial-flights-tracker-map/" target="_blank" rel="noopener">truly outstanding kernel</a> by <a href="https://www.kaggle.com/jonathanbouchet" target="_blank" rel="noopener">Jonathan Bouchet</a>. (If you haven’t seen his kernel, then I strongly recommend you check it out; right after reading this one, of course ;-) ).</p>
<h3 id="Longer-than-a-day"><a href="#Longer-than-a-day" class="headerlink" title="Longer than a day"></a>Longer than a day</h3><p>We start with the few trips that pretend to have taken several days to complete:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">day_plus_trips &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(trip_duration &gt; 24*3600)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">day_plus_trips %&gt;% select(pickup_datetime, dropoff_datetime, speed)</span><br></pre></td></tr></table></figure>





<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ny_map &lt;- as.tibble(map_data(&quot;state&quot;, region &#x3D; &quot;new york:manhattan&quot;))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tpick &lt;- day_plus_trips %&gt;%</span><br><span class="line"></span><br><span class="line">  select(lon &#x3D; pickup_longitude, lat &#x3D; pickup_latitude)</span><br><span class="line"></span><br><span class="line">tdrop &lt;- day_plus_trips %&gt;%</span><br><span class="line"></span><br><span class="line">  select(lon &#x3D; dropoff_longitude, lat &#x3D; dropoff_latitude)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1 &lt;- ggplot() +</span><br><span class="line"></span><br><span class="line">  geom_polygon(data&#x3D;ny_map, aes(x&#x3D;long, y&#x3D;lat), fill &#x3D; &quot;grey60&quot;) +</span><br><span class="line"></span><br><span class="line">  geom_point(data&#x3D;tpick,aes(x&#x3D;lon,y&#x3D;lat),size&#x3D;1,color&#x3D;&#39;red&#39;,alpha&#x3D;1) +</span><br><span class="line"></span><br><span class="line">  geom_point(data&#x3D;tdrop,aes(x&#x3D;lon,y&#x3D;lat),size&#x3D;1,color&#x3D;&#39;blue&#39;,alpha&#x3D;1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for (i in seq(1,nrow(tpick)))&#123;</span><br><span class="line"></span><br><span class="line">  inter &lt;- as.tibble(gcIntermediate(tpick[i,],  tdrop[i,], n&#x3D;30, addStartEnd&#x3D;TRUE))</span><br><span class="line"></span><br><span class="line">  p1 &lt;- p1 +  geom_line(data&#x3D;inter,aes(x&#x3D;lon,y&#x3D;lat),color&#x3D;&#39;blue&#39;,alpha&#x3D;.75)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1 + ggtitle(&quot;Longer than a day trips in relation to Manhattan&quot;)</span><br><span class="line"></span><br><span class="line">p1 &lt;- 1</span><br></pre></td></tr></table></figure>



<p>We find nothing out of the ordinary here. While a trip to JFK can seem like an eternity if your flight is boarding soon, it is unlikely to take this long in real time. The average taxi speeds don’t look very likely either. </p>
<p><strong>Decision:</strong> These values should be removed from the training data set for continued exploration and modelling.</p>
<h3 id="Close-to-24-hours"><a href="#Close-to-24-hours" class="headerlink" title="Close to 24 hours"></a>Close to 24 hours</h3><p>Call me crazy, but I don’t think it is inconceivable that someone takes a taxi for a trip that lasts almost a day (with breaks, of course). In very rare occasions this might happen; provided, of course, that the distance travelled was sufficiently long.</p>
<p>Here we define day-long trips as taking between 22 and 24 hours, which covers a small peak in our raw <em>trip_duration</em> distribution. Those are the top 5 direct distances (in m) among the day-long trips:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">day_trips &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(trip_duration &lt; 24*3600 &amp; trip_duration &gt; 22*3600)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">day_trips %&gt;% </span><br><span class="line"></span><br><span class="line">  arrange(desc(dist)) %&gt;%</span><br><span class="line"></span><br><span class="line">  select(dist, pickup_datetime, dropoff_datetime, speed) %&gt;%</span><br><span class="line"></span><br><span class="line">  head(5)</span><br></pre></td></tr></table></figure>



<p>The top one is about 60 km (about 37 miles), which is not particularly far. The average speed wouldn’t suggest a generous tip, either. What do these trips look like on the map?</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ny_map &lt;- as.tibble(map_data(&quot;state&quot;, region &#x3D; &quot;new york:manhattan&quot;))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">set.seed(2017)</span><br><span class="line"></span><br><span class="line">day_trips &lt;- day_trips %&gt;%</span><br><span class="line"></span><br><span class="line">  sample_n(200)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tpick &lt;- day_trips %&gt;%</span><br><span class="line"></span><br><span class="line">  select(lon &#x3D; pickup_longitude, lat &#x3D; pickup_latitude)</span><br><span class="line"></span><br><span class="line">tdrop &lt;- day_trips %&gt;%</span><br><span class="line"></span><br><span class="line">  select(lon &#x3D; dropoff_longitude, lat &#x3D; dropoff_latitude)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1 &lt;- ggplot() +</span><br><span class="line"></span><br><span class="line">  geom_polygon(data&#x3D;ny_map, aes(x&#x3D;long, y&#x3D;lat), fill &#x3D; &quot;grey60&quot;) +</span><br><span class="line"></span><br><span class="line">  geom_point(data&#x3D;tpick,aes(x&#x3D;lon,y&#x3D;lat),size&#x3D;1,color&#x3D;&#39;red&#39;,alpha&#x3D;1) +</span><br><span class="line"></span><br><span class="line">  geom_point(data&#x3D;tdrop,aes(x&#x3D;lon,y&#x3D;lat),size&#x3D;1,color&#x3D;&#39;blue&#39;,alpha&#x3D;1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for (i in seq(1,nrow(tpick)))&#123;</span><br><span class="line"></span><br><span class="line">  inter &lt;- as.tibble(gcIntermediate(tpick[i,],  tdrop[i,], n&#x3D;30, addStartEnd&#x3D;TRUE))</span><br><span class="line"></span><br><span class="line">  p1 &lt;- p1 +  geom_line(data&#x3D;inter,aes(x&#x3D;lon,y&#x3D;lat),color&#x3D;&#39;blue&#39;,alpha&#x3D;.25)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1 + ggtitle(&quot;Day-long trips in relation to Manhattan&quot;)</span><br><span class="line"></span><br><span class="line">p1 &lt;- 1</span><br></pre></td></tr></table></figure>



<p>Here we are plotting only 200 of the about 1800 connections to keep the map reasonably readable and the script fast. Pickup points are red and dropoff points are blue.</p>
<p>We find:</p>
<ul>
<li>A few longer distances stand out, but they are exceptions. The two major group of trips are those within Manhattan and those between Manhattan and the airports.</li>
</ul>
<ul>
<li>There is little to suggest that these extreme <em>trip_durations</em> were real. </li>
</ul>
<ul>
<li>There is another insight here which is rather intuitive: trips to or from any of the airports (most prominently JFK) are unlikely to be very short. <strong>Thus, the a close distance of either pickup or dropoff to the airport could be a valuable predictor for longer <em>trip_duration</em>.</strong> This is something that we took from here to the feature engineering.</li>
</ul>
<p><strong>Decision:</strong> We will remove <em>trip_durations</em> longer than 22 hours from the exploration and possibly from the modelling.</p>
<h3 id="Shorter-than-a-few-minutes"><a href="#Shorter-than-a-few-minutes" class="headerlink" title="Shorter than a few minutes"></a>Shorter than a few minutes</h3><p>On the other side of the <em>trip_duration</em> distribution we have those rides that appear to only have lasted for a couple of minutes. While such short trips are entirely possible, let’s check their durations and speeds to make sure that they are realistic.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">min_trips &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(trip_duration &lt; 5*60)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">min_trips %&gt;% </span><br><span class="line"></span><br><span class="line">  arrange(dist) %&gt;%</span><br><span class="line"></span><br><span class="line">  select(dist, pickup_datetime, dropoff_datetime, speed) %&gt;%</span><br><span class="line"></span><br><span class="line">  head(5)</span><br></pre></td></tr></table></figure>



<h4 id="Zero-distance-trips"><a href="#Zero-distance-trips" class="headerlink" title="Zero-distance trips"></a>Zero-distance trips</h4><p>In doing so, we notice that there are a relatively large number of zero-distance trips:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">zero_dist &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(near(dist,0))</span><br><span class="line"></span><br><span class="line">nrow(zero_dist)</span><br></pre></td></tr></table></figure>



<p>What are their nominal top durations?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">zero_dist %&gt;%</span><br><span class="line"></span><br><span class="line">  arrange(desc(trip_duration)) %&gt;%</span><br><span class="line"></span><br><span class="line">  select(trip_duration, pickup_datetime, dropoff_datetime, vendor_id) %&gt;%</span><br><span class="line"></span><br><span class="line">  head(5)</span><br></pre></td></tr></table></figure>



<p>There really are a few taxis where the data wants to tell us that they have not moved at all for about a day. While carrying a passenger. We choose not to believe the data in this case.</p>
<p>Once we remove the extreme cases, this is what the distribution looks like:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">zero_dist %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(trip_duration &lt; 6000) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(trip_duration, fill &#x3D; vendor_id)) +</span><br><span class="line"></span><br><span class="line">  geom_histogram(bins &#x3D; 50) +</span><br><span class="line"></span><br><span class="line">  scale_x_log10()</span><br></pre></td></tr></table></figure>



<p>We find:</p>
<ul>
<li><em>trip_durations</em> of about a minute might still be somehow possible, assuming that someone got into a taxi but then changed their mind before the taxi could move. Whether that should count as a “trip” is a different question. But trip durations of about 15 minutes (900 s) without any distance covered seem hardly possible. Unless they involve traffic jams, but who get’s into a taxi that’s stuck in a traffic jam?</li>
</ul>
<ul>
<li>It is also noteworthy that most trips in the less-than-a-minute-group were from vendor 1, whereas the 10-minute-group predominantly consists of vendor 2 taxis.</li>
</ul>
<p><strong>Decision:</strong> We will remove those zero-distance trips that took more than a minute for our continued analysis. Removing them from the modelling might be detrimental if there are similar trips in the test sample.</p>
<h4 id="Short-trips-with-above-zero-distance"><a href="#Short-trips-with-above-zero-distance" class="headerlink" title="Short trips with above zero distance"></a>Short trips with above zero distance</h4><p>After removing the zero-distance trips, those are the short rides with the highest average speed:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">min_trips &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(trip_duration &lt; 5*60 &amp; dist &gt; 0)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">min_trips %&gt;% </span><br><span class="line"></span><br><span class="line">  arrange(desc(speed)) %&gt;%</span><br><span class="line"></span><br><span class="line">  select(trip_duration, dist, pickup_datetime, speed) %&gt;%</span><br><span class="line"></span><br><span class="line">  head(10)</span><br></pre></td></tr></table></figure>



<p>Clearly, the top speed values are impossible. We include a map plot of the general distribution of distances within the sample:</p>
<figure class="highlight plain"><figcaption><span>eval</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ny_map &lt;- as.tibble(map_data(&quot;state&quot;, region &#x3D; &quot;new york:manhattan&quot;))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">set.seed(1234)</span><br><span class="line"></span><br><span class="line">foo &lt;- min_trips %&gt;%</span><br><span class="line"></span><br><span class="line">  sample_n(600)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tpick &lt;- foo %&gt;%</span><br><span class="line"></span><br><span class="line">  select(lon &#x3D; pickup_longitude, lat &#x3D; pickup_latitude)</span><br><span class="line"></span><br><span class="line">tdrop &lt;- foo %&gt;%</span><br><span class="line"></span><br><span class="line">  select(lon &#x3D; dropoff_longitude, lat &#x3D; dropoff_latitude)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1 &lt;- ggplot() +</span><br><span class="line"></span><br><span class="line">  geom_polygon(data&#x3D;ny_map, aes(x&#x3D;long, y&#x3D;lat), fill &#x3D; &quot;grey60&quot;) +</span><br><span class="line"></span><br><span class="line">  geom_point(data&#x3D;tpick,aes(x&#x3D;lon,y&#x3D;lat),size&#x3D;1,color&#x3D;&#39;red&#39;,alpha&#x3D;1) +</span><br><span class="line"></span><br><span class="line">  geom_point(data&#x3D;tdrop,aes(x&#x3D;lon,y&#x3D;lat),size&#x3D;1,color&#x3D;&#39;blue&#39;,alpha&#x3D;1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for (i in seq(1,nrow(tpick)))&#123;</span><br><span class="line"></span><br><span class="line">  inter &lt;- as.tibble(gcIntermediate(tpick[i,],  tdrop[i,], n&#x3D;30, addStartEnd&#x3D;TRUE))</span><br><span class="line"></span><br><span class="line">  p1 &lt;- p1 +  geom_line(data&#x3D;inter,aes(x&#x3D;lon,y&#x3D;lat),color&#x3D;&#39;blue&#39;,alpha&#x3D;.25)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1 + ggtitle(&quot;Minute-long trips in relation to Manhattan&quot;)</span><br><span class="line"></span><br><span class="line">p1 &lt;- 1</span><br></pre></td></tr></table></figure>



<p>We find (from the hidden plot):</p>
<ul>
<li>Most distances are in fact short, which means that combined with setting an average speed limit we should be able to remove those values that are way beyond being realistic. This should also get rid of many trips that appear to have durations of seconds only.</li>
</ul>
<p><strong>Decision:</strong> We impose a lower <em>trip_duration</em> limit of 10 seconds and a (very conservative) speed limit of 100 km/h (62 mph). (Remember that this refers to the direct distance.)</p>
<h2 id="Intermission-The-best-spurious-trips"><a href="#Intermission-The-best-spurious-trips" class="headerlink" title="Intermission - The best spurious trips"></a>Intermission - The best spurious trips</h2><p>Every data set has a few entries that are just flat out ridiculous. Here are the best ones from this one, with pickup or dropoff locations more than 300 km away from NYC (JFK airport)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">long_dist &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter( (jfk_dist_pick &gt; 3e5) | (jfk_dist_drop &gt; 3e5) )</span><br><span class="line"></span><br><span class="line">long_dist_coord &lt;- long_dist %&gt;%</span><br><span class="line"></span><br><span class="line">  select(lon &#x3D; pickup_longitude, lat &#x3D; pickup_latitude)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">long_dist %&gt;%</span><br><span class="line"></span><br><span class="line">  select(id, jfk_dist_pick, jfk_dist_drop, dist, trip_duration, speed) %&gt;%</span><br><span class="line"></span><br><span class="line">  arrange(desc(jfk_dist_pick))</span><br></pre></td></tr></table></figure>



<p>Many zero-distance trips with more than a minute duration, which we would remove anyway. But just out of curiousity, where did they happen? (We will again use the amazing <em>leaflet</em> package, this time with individual markers that give us <em>id</em> and direct <em>distance</em> information for mouse-over and click actions.)</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">leaflet(long_dist_coord) %&gt;%</span><br><span class="line"></span><br><span class="line">  addTiles() %&gt;%</span><br><span class="line"></span><br><span class="line">  setView(-92.00, 41.0, zoom &#x3D; 4) %&gt;%</span><br><span class="line"></span><br><span class="line">  addProviderTiles(&quot;CartoDB.Positron&quot;) %&gt;%</span><br><span class="line"></span><br><span class="line">  addMarkers(popup &#x3D; ~as.character(long_dist$dist), label &#x3D; ~as.character(long_dist$id))</span><br></pre></td></tr></table></figure>



<p>See what I mean?</p>
<p>Not only are there two(!) lone NYC taxis near San Francisco, but 9 others are actually ocean-going taxis, who knew ;-) . Most of the others will be removed by our previous cleaning limits.</p>
<p><strong>These long-distance locations represent outliers that should be removed to improve the robustness of predictive models.</strong></p>
<h2 id="Final-cleaning"><a href="#Final-cleaning" class="headerlink" title="Final cleaning"></a>Final cleaning</h2><p>Here we apply the cleaning filters that are discussed above. This code block is likely to expand as the analysis progresses.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">train &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(trip_duration &lt; 22*3600,</span><br><span class="line"></span><br><span class="line">         dist &gt; 0 | (near(dist, 0) &amp; trip_duration &lt; 60),</span><br><span class="line"></span><br><span class="line">         jfk_dist_pick &lt; 3e5 &amp; jfk_dist_drop &lt; 3e5,</span><br><span class="line"></span><br><span class="line">         trip_duration &gt; 10,</span><br><span class="line"></span><br><span class="line">         speed &lt; 100)</span><br></pre></td></tr></table></figure>





<h1 id="External-data"><a href="#External-data" class="headerlink" title="External data"></a>External data</h1><p>In this playground competition we have been encouraged to supplement our analysis with additional data sources. These are published as Kaggle data set and are being collected in <a href="https://www.kaggle.com/c/nyc-taxi-trip-duration/discussion/36699" target="_blank" rel="noopener">this discussion thread</a>.</p>
<p>In fact, there are <a href="https://www.kaggle.com/c/nyc-taxi-trip-duration#Prizes" target="_blank" rel="noopener">monetary prizes</a> for publishing the top 4 data sets, which together with the Kernel awards gives this competition a fresh and interesting spin.</p>
<p>If you want to know more about how to include multiple data sources in your Kaggle kernel then check out <a href="https://www.kaggle.com/product-feedback/32423" target="_blank" rel="noopener">this article</a>.</p>
<h2 id="Weather-reports"><a href="#Weather-reports" class="headerlink" title="Weather reports"></a>Weather reports</h2><p>We start by incorporating a list of <em>NYC weather data</em> provided by <a href="https://www.kaggle.com/mathijs" target="_blank" rel="noopener">Mathijs Waegemakers</a> right <a href="https://www.kaggle.com/mathijs/weather-data-in-new-york-city-2016" target="_blank" rel="noopener">here</a>. In the next paragraph I copy the data description verbatim:</p>
<blockquote>
<p>Weather data collected from the National Weather Service. It contains the first six months of 2016, for a weather station in central park. It contains for each day the minimum temperature, maximum temperature, average temperature, precipitation, new snow fall, and current snow depth. The temperature is measured in Fahrenheit and the depth is measured in inches. T means that there is a trace of precipitation.</p>
</blockquote>
<p>Of particular interest here will be the rain and snow fall statistics, which I’m curious to compare to the dip in trip numbers in late January. Check also <a href="https://www.kaggle.com/naveenjafer/weather-and-avg-speed-correlation/" target="_blank" rel="noopener">this kernel</a> which presents an independent analysis of the same data set.</p>
<h3 id="Data-import-overview-formatting-joining"><a href="#Data-import-overview-formatting-joining" class="headerlink" title="Data import, overview, formatting, joining"></a>Data import, overview, formatting, joining</h3><p>The data can be found in the data set sub-directory of the <code>../input</code> directory and it looks like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">weather &lt;- as.tibble(fread(&quot;..&#x2F;input&#x2F;weather-data-in-new-york-city-2016&#x2F;weather_data_nyc_centralpark_2016(1).csv&quot;))</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">glimpse(weather)</span><br></pre></td></tr></table></figure>



<p>We turn the <em>date</em> into a <em>lubridate</em> object and convert the traces (“T”) of rain and snow into small numeric amounts. We also save the maximum and minimum temperature in a shorter form:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">weather &lt;- weather %&gt;%</span><br><span class="line"></span><br><span class="line">  mutate(date &#x3D; dmy(date),</span><br><span class="line"></span><br><span class="line">         rain &#x3D; as.numeric(ifelse(precipitation &#x3D;&#x3D; &quot;T&quot;, &quot;0.01&quot;, precipitation)),</span><br><span class="line"></span><br><span class="line">         s_fall &#x3D; as.numeric(ifelse(&#96;snow fall&#96; &#x3D;&#x3D; &quot;T&quot;, &quot;0.01&quot;, &#96;snow fall&#96;)),</span><br><span class="line"></span><br><span class="line">         s_depth &#x3D; as.numeric(ifelse(&#96;snow depth&#96; &#x3D;&#x3D; &quot;T&quot;, &quot;0.01&quot;, &#96;snow depth&#96;)),</span><br><span class="line"></span><br><span class="line">         all_precip &#x3D; s_fall + rain,</span><br><span class="line"></span><br><span class="line">         has_snow &#x3D; (s_fall &gt; 0) | (s_depth &gt; 0),</span><br><span class="line"></span><br><span class="line">         has_rain &#x3D; rain &gt; 0,</span><br><span class="line"></span><br><span class="line">         max_temp &#x3D; &#96;maximum temperature&#96;,</span><br><span class="line"></span><br><span class="line">         min_temp &#x3D; &#96;minimum temperature&#96;)</span><br></pre></td></tr></table></figure>



<p>Then we join this information to our training data using the common <em>data</em> column:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">foo &lt;- weather %&gt;%</span><br><span class="line"></span><br><span class="line">  select(date, rain, s_fall, all_precip, has_snow, has_rain, s_depth, max_temp, min_temp)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">train &lt;- left_join(train, foo, by &#x3D; &quot;date&quot;)</span><br></pre></td></tr></table></figure>





<h3 id="Visualisation-and-impact-on-trip-duration"><a href="#Visualisation-and-impact-on-trip-duration" class="headerlink" title="Visualisation and impact on trip_duration"></a>Visualisation and impact on <em>trip_duration</em></h3><p>Let’s compare the snow fall statistics to our trip numbers per day:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">p1 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  group_by(date) %&gt;%</span><br><span class="line"></span><br><span class="line">  count() %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(date,n&#x2F;1e3)) +</span><br><span class="line"></span><br><span class="line">  geom_line(size &#x3D; 1.5, color &#x3D; &quot;red&quot;) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;&quot;, y &#x3D; &quot;Kilo trips per day&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p2 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  group_by(date) %&gt;%</span><br><span class="line"></span><br><span class="line">  summarise(trips &#x3D; n(),</span><br><span class="line"></span><br><span class="line">            snow_fall &#x3D; mean(s_fall),</span><br><span class="line"></span><br><span class="line">            rain_fall &#x3D; mean(rain),</span><br><span class="line"></span><br><span class="line">            all_precip &#x3D; mean(all_precip)) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(date, snow_fall)) +</span><br><span class="line"></span><br><span class="line">  geom_line(color &#x3D; &quot;blue&quot;, size &#x3D; 1.5) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;&quot;, y &#x3D; &quot;Snowfall&quot;) +</span><br><span class="line"></span><br><span class="line">  scale_y_sqrt() +</span><br><span class="line"></span><br><span class="line">  scale_x_date(limits &#x3D; ymd(c(&quot;2015-12-28&quot;, &quot;2016-06-30&quot;)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p3 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  group_by(date) %&gt;%</span><br><span class="line"></span><br><span class="line">  summarise(trips &#x3D; n(),</span><br><span class="line"></span><br><span class="line">            snow_depth &#x3D; mean(s_depth)) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(date, snow_depth)) +</span><br><span class="line"></span><br><span class="line">  geom_line(color &#x3D; &quot;purple&quot;, size &#x3D; 1.5) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;&quot;, y &#x3D; &quot;Snow depth&quot;) +</span><br><span class="line"></span><br><span class="line">  scale_y_sqrt() +</span><br><span class="line"></span><br><span class="line">  scale_x_date(limits &#x3D; ymd(c(&quot;2015-12-29&quot;, &quot;2016-06-30&quot;)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p4 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  group_by(date) %&gt;%</span><br><span class="line"></span><br><span class="line">  summarise(median_speed &#x3D; median(speed)) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(date, median_speed)) +</span><br><span class="line"></span><br><span class="line">  geom_line(color &#x3D; &quot;orange&quot;, size &#x3D; 1.5) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Date&quot;, y &#x3D; &quot;Median speed&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">layout &lt;- matrix(c(1,2,3,4),4,1,byrow&#x3D;FALSE)</span><br><span class="line"></span><br><span class="line">multiplot(p1, p2, p3, p4, layout&#x3D;layout)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1 &lt;- 1; p2 &lt;- 1; p3 &lt;- 1; p4 &lt;- 1</span><br></pre></td></tr></table></figure>



<p>I knew it! The dip in trip volume corresponds to the largest (and first?) snow fall of the winter in NYC (Jan 23rd). In fact, NYC was hit by a blizzard and experienced <a href="https://www.weather.gov/okx/Blizzard_Jan2016" target="_blank" rel="noopener">record-breaking snowfall</a>. The impact on the traffic patterns was enormous, and the median speed slowed down notably. (Note the square-root y-axis in the two middle plots.)</p>
<p>After this large spike, we clearly see that the following periods of snow fall, albeit signficantly less heavy, have nowhere near as large an effect on the number of taxi trips or their velocities. A possible exception might have been the last snow in mid March, which due to the fact that it hadn’t snowed in a while might have caught people by surprise.</p>
<p>Now, do lower numbers of trips in snowy weather also lead to longer journeys? To answer this question we look at a scatter plot between the average trip duration and the total precipitation (rain + snow) for all days in our sample:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">train %&gt;%</span><br><span class="line"></span><br><span class="line">  group_by(date, has_snow) %&gt;%</span><br><span class="line"></span><br><span class="line">  summarise(duration &#x3D; mean(trip_duration),</span><br><span class="line"></span><br><span class="line">            all_precip &#x3D; mean(all_precip)) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(all_precip, duration, color &#x3D; has_snow)) +</span><br><span class="line"></span><br><span class="line">  geom_jitter(width &#x3D; 0.04, size &#x3D; 2) +</span><br><span class="line"></span><br><span class="line">  scale_x_sqrt() +</span><br><span class="line"></span><br><span class="line">  scale_y_log10() +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Amount of total precipitation&quot;, y &#x3D; &quot;Average trip duration&quot;)</span><br></pre></td></tr></table></figure>





<p>We find that except for a snow day with long-duration trips it seems more like snow would lead to shorter trips. However, this could simply mean that passengers were more likely to travel shorter distances, so how does the average speed compare?</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">p1 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(speed &lt; 50) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(has_snow, speed, color &#x3D; has_snow)) +</span><br><span class="line"></span><br><span class="line">  geom_boxplot() +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Snowfall&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p2 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(speed &lt; 50) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(has_rain, speed, color &#x3D; has_rain)) +</span><br><span class="line"></span><br><span class="line">  geom_boxplot() +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Rainfall&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">layout &lt;- matrix(c(1,2),1,2,byrow&#x3D;FALSE)</span><br><span class="line"></span><br><span class="line">multiplot(p1, p2, layout&#x3D;layout)</span><br><span class="line"></span><br><span class="line">p1 &lt;- 1; p2 &lt;- 1</span><br></pre></td></tr></table></figure>



<p>We find that there is no significant difference here. Moreover, Jan 23rd (blizzard) is not at the top of the list of snow days with the longest median <em>trip_duration</em> (it’s in the top 10, though).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(has_snow &#x3D;&#x3D; TRUE) %&gt;%</span><br><span class="line"></span><br><span class="line">  group_by(date) %&gt;%</span><br><span class="line"></span><br><span class="line">  summarise(med_duration &#x3D; median(trip_duration),</span><br><span class="line"></span><br><span class="line">            med_speed &#x3D; median(speed)) %&gt;%</span><br><span class="line"></span><br><span class="line">  arrange(desc(med_duration)) %&gt;%</span><br><span class="line"></span><br><span class="line">  head(10)</span><br></pre></td></tr></table></figure>



<p>We can spot a different interesting pattern in this table, though, when looking at the top 5 slowest snow days. Interestingly, the overall lowest median speeds were observed <em>two days after</em> the blizzard: from Jan 25th until 27th (although note that the day immediately after the blizzard, Jan 24th, was a Sunday):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">train %&gt;%</span><br><span class="line"></span><br><span class="line">  group_by(date) %&gt;%</span><br><span class="line"></span><br><span class="line">  summarise(med_duration &#x3D; median(trip_duration),</span><br><span class="line"></span><br><span class="line">            med_speed &#x3D; median(speed)) %&gt;%</span><br><span class="line"></span><br><span class="line">  arrange(med_speed) %&gt;%</span><br><span class="line"></span><br><span class="line">  head(5)</span><br></pre></td></tr></table></figure>



<p><strong>Conclusion:</strong> From an exploratory point of view this doesn’t look too promising. Still, I’m inclined to include the rain and snow fall occurence in a tentative model to see whether it shows any interaction terms that we can’t see at the moment. The “blizzard effect” on the (working) week after the heavy snow fall is probably worth taking into account separately. <strong>Thus, we create a <em>blizzard</em> feature in our engineering code block.</strong></p>
<h2 id="Fastest-Routes"><a href="#Fastest-Routes" class="headerlink" title="Fastest Routes"></a>Fastest Routes</h2><p>Another interesting external data set is an estimate of the <em>fastest routes for each trip</em> provided by <a href="https://www.kaggle.com/oscarleo" target="_blank" rel="noopener">oscarleo</a> using the the Open Source Routing Machine, <a href="http://project-osrm.org/" target="_blank" rel="noopener">OSRM</a>. The data can be found <a href="https://www.kaggle.com/oscarleo/new-york-city-taxi-with-osrm" target="_blank" rel="noopener">here</a> and includes the pickup/dropoff streets and total distance/duration between these two points together with a sequence of travels steps such as turns or entering a highway.</p>
<p>Note, that according to <a href="https://www.kaggle.com/c/nyc-taxi-trip-duration/discussion/37033" target="_blank" rel="noopener">discussion items</a> those really are the “fastest”, not the shortest, routes between the two points. This will most likely not account for traffic volume, and the fastest route on one day might not be the fastest on another day of the week. Still, here we have an actual driving distance and duration measure that should be valuable for our prediction goal.</p>
<h3 id="Data-import-and-overview"><a href="#Data-import-and-overview" class="headerlink" title="Data import and overview"></a>Data import and overview</h3><p>The data comes in three separate files, split into the <em>train</em> (2 files) vs <em>test</em> trip IDs. Here, we will load and examine the data corresponding to the training observations. Note, that this data set is more than twice as large as our original training data.</p>
<figure class="highlight plain"><figcaption><span>warning</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">foo &lt;- as.tibble(fread(&quot;..&#x2F;input&#x2F;new-york-city-taxi-with-osrm&#x2F;fastest_routes_train_part_1.csv&quot;))</span><br><span class="line"></span><br><span class="line">bar &lt;- as.tibble(fread(&quot;..&#x2F;input&#x2F;new-york-city-taxi-with-osrm&#x2F;fastest_routes_train_part_2.csv&quot;))</span><br><span class="line"></span><br><span class="line">foobar &lt;- as.tibble(fread(&quot;..&#x2F;input&#x2F;new-york-city-taxi-with-osrm&#x2F;fastest_routes_test.csv&quot;))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fastest_route &lt;- bind_rows(foo, bar, foobar)</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">glimpse(fastest_route)</span><br></pre></td></tr></table></figure>



<p>The glimpse view shows us that indeed for each step the streets are named (<em>streets_for_each_step</em>) alongside a detailed account of the <em>distance_per_step</em>, <em>travel_time_per_step</em>, and the <em>step_maneuvers</em> and <em>step_direction</em> describing the journey. The <em>step_maneuvers</em> are named in a pretty self-explanatory way and are also described in the data set <a href="https://www.kaggle.com/oscarleo/new-york-city-taxi-with-osrm" target="_blank" rel="noopener">overview</a>. <em>Depart</em> and <em>arrive</em> are individual steps. The direction of a <em>step_maneuver</em> “turn” is listed in the the <em>step_directions</em>. The total distance is measured in <em>meters</em> and the duration in <em>seconds</em>, like in the original data.</p>
<h3 id="New-data-visualisations"><a href="#New-data-visualisations" class="headerlink" title="New data visualisations"></a>New data visualisations</h3><p>Before joining the “fastest routes” data to our training set, let’s first visualise the distributions of the numerical parameters:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">p1 &lt;- fastest_route %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(total_travel_time)) +</span><br><span class="line"></span><br><span class="line">  geom_histogram(bins &#x3D; 150, fill &#x3D; &quot;red&quot;) +</span><br><span class="line"></span><br><span class="line">  scale_x_log10() +</span><br><span class="line"></span><br><span class="line">  scale_y_sqrt()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p2 &lt;- fastest_route %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(total_distance)) +</span><br><span class="line"></span><br><span class="line">  geom_histogram(bins &#x3D; 150, fill &#x3D; &quot;red&quot;) +</span><br><span class="line"></span><br><span class="line">  scale_x_log10() +</span><br><span class="line"></span><br><span class="line">  scale_y_sqrt()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p3 &lt;- fastest_route %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(number_of_steps)) +</span><br><span class="line"></span><br><span class="line">  geom_bar(fill &#x3D; &quot;red&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p4 &lt;- fastest_route %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(total_distance, total_travel_time)) +</span><br><span class="line"></span><br><span class="line">  geom_bin2d(bins &#x3D; c(80,80))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">layout &lt;- matrix(c(1,2,3,4,4,4),2,3,byrow&#x3D;TRUE)</span><br><span class="line"></span><br><span class="line">multiplot(p1, p2, p3, p4, layout&#x3D;layout)</span><br><span class="line"></span><br><span class="line">p1 &lt;- 1; p2 &lt;- 1; p3 &lt;- 1; p4 &lt;- 1</span><br></pre></td></tr></table></figure>



<p>We find:</p>
<ul>
<li>The <em>total_travel_time</em> and <em>total_distance</em> peak at values of around 300 s (5 min) and 2800 m, respectively. These are the median values. Really high values are rare in both features, however there is are indications for secondary peaks towards longer times and distances. Very short distances (few meters) and travel times (few seconds) are present in the data.</li>
</ul>
<ul>
<li>The single most frequent <em>number_of_steps</em> is 5. Since “depart” and “arrive” are always present, there are no trips with less than 2 steps. There are almost 60k trips that only contain these two steps, which would mean that they would have at most travelled in a straight line, as far as I can see:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">fastest_route %&gt;% filter(number_of_steps &#x3D;&#x3D; 2) %&gt;% nrow()</span><br></pre></td></tr></table></figure>



<ul>
<li>Larger number of steps are present, but only about 20% are above 10 and less than 2% are above 20 steps.</li>
</ul>
<ul>
<li><em>total_distance</em> and <em>total_travel_time</em> are strongly correlated in a pretty linear way; except for possibly the very short distances. There is a certain amout of scatter around this linear dependency and it looks rather homogeneous over the entire range of distances and times.</li>
</ul>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">fastest_route %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(factor(number_of_steps), total_travel_time, color &#x3D; factor(number_of_steps))) +</span><br><span class="line"></span><br><span class="line">  geom_boxplot() +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;number_of_steps&quot;) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br></pre></td></tr></table></figure>



<p>We also find that the median travel time correlates well with the <em>number_of_steps</em>, but that there is also much overlap between neighbouring step counts, along with numerous outliers predominantly towards longer durations.</p>
<p>The distributions of <em>total_distance</em> per <em>number_of_steps</em> look very similar to the plot above.</p>
<h3 id="Joining-and-derived-features"><a href="#Joining-and-derived-features" class="headerlink" title="Joining and derived features"></a>Joining and derived features</h3><p>In a first look at the joined data, we will mainly focus on the <em>total_distance</em> and <em>total_travel_time</em>, when combined with our original training data set:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">foo &lt;- fastest_route %&gt;%</span><br><span class="line"></span><br><span class="line">  select(id, total_distance, total_travel_time, number_of_steps,</span><br><span class="line"></span><br><span class="line">         step_direction, step_maneuvers) %&gt;%</span><br><span class="line"></span><br><span class="line">  mutate(fastest_speed &#x3D; total_distance&#x2F;total_travel_time*3.6,</span><br><span class="line"></span><br><span class="line">         left_turns &#x3D; str_count(step_direction, &quot;left&quot;),</span><br><span class="line"></span><br><span class="line">         right_turns &#x3D; str_count(step_direction, &quot;right&quot;),</span><br><span class="line"></span><br><span class="line">         turns &#x3D; str_count(step_maneuvers, &quot;turn&quot;)</span><br><span class="line"></span><br><span class="line">         ) %&gt;%</span><br><span class="line"></span><br><span class="line">  select(-step_direction, -step_maneuvers)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">train &lt;- left_join(train, foo, by &#x3D; &quot;id&quot;) %&gt;%</span><br><span class="line"></span><br><span class="line">  mutate(fast_speed_trip &#x3D; total_distance&#x2F;trip_duration*3.6)</span><br></pre></td></tr></table></figure>



<p>In addition, we also create the following new features:</p>
<ul>
<li><em>fastest_speed</em> is the average speed of the fastest route based on the OSRM values, and <em>fast_speed_trip</em> is the speed assuming the fastest route and the actual trip duration. Both features are in units of km/h.</li>
</ul>
<ul>
<li><em>left_turns</em>, <em>right_turns</em>, and <em>turns</em> are the total number of those maneuvers per route. The <em>step_directions</em> “left” and “right” might not always be associated to the <em>step_maneuver</em> “turn”, but in most cases they are so we are using them as a first estimate of the number of left and right turns. Especially left turns might slow down travel. </li>
</ul>
<p>Beyond that, for instance the detailed list of streets used and their respective <em>travel_time_per_step</em> might allow us to take into account known areas of slow traffic.</p>
<h3 id="Visualisation-and-impact-on-trip-duration-1"><a href="#Visualisation-and-impact-on-trip-duration-1" class="headerlink" title="Visualisation and impact on trip_duration"></a>Visualisation and impact on <em>trip_duration</em></h3><figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">p1 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(trip_duration)) +</span><br><span class="line"></span><br><span class="line">  geom_density(fill &#x3D; &quot;red&quot;, alpha &#x3D; 0.5) +</span><br><span class="line"></span><br><span class="line">  geom_density(aes(total_travel_time), fill &#x3D; &quot;blue&quot;, alpha &#x3D; 0.5) +</span><br><span class="line"></span><br><span class="line">  scale_x_log10() +</span><br><span class="line"></span><br><span class="line">  coord_cartesian(xlim &#x3D; c(5e1, 8e3))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p2 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(dist)) +</span><br><span class="line"></span><br><span class="line">  geom_density(fill &#x3D; &quot;red&quot;, alpha &#x3D; 0.5) +</span><br><span class="line"></span><br><span class="line">  geom_density(aes(total_distance), fill &#x3D; &quot;blue&quot;, alpha &#x3D; 0.5) +</span><br><span class="line"></span><br><span class="line">  scale_x_log10() +</span><br><span class="line"></span><br><span class="line">  coord_cartesian(xlim &#x3D; c(2e2, 5e4))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p3 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(trip_duration, total_travel_time)) +</span><br><span class="line"></span><br><span class="line">  geom_bin2d(bins &#x3D; c(120,120)) +</span><br><span class="line"></span><br><span class="line">  geom_abline(intercept &#x3D; 0, slope &#x3D; 1, colour &#x3D; &quot;red&quot;) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p4 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(dist, total_distance)) +</span><br><span class="line"></span><br><span class="line">  geom_bin2d(bins &#x3D; c(70,70)) +</span><br><span class="line"></span><br><span class="line">  geom_abline(intercept &#x3D; 0, slope &#x3D; 1, colour &#x3D; &quot;red&quot;) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">layout &lt;- matrix(c(1,2,3,4),2,2,byrow&#x3D;TRUE)</span><br><span class="line"></span><br><span class="line">multiplot(p1, p2, p3, p4, layout&#x3D;layout)</span><br><span class="line"></span><br><span class="line">p1 &lt;- 1; p2 &lt;- 1; p3 &lt;- 1; p4 &lt;- 1</span><br></pre></td></tr></table></figure>



<p>Here the <em>fastest</em> features are in blue and the original <em>trip_duration</em> and direct <em>dist</em>ance in red. In the binned scatter plots the red line has slope 1.</p>
<p>We find:</p>
<ul>
<li>The actual <em>trip_durations</em> are on average significantly longer than those for the fastest route. The shape of the distributions is also subtly different, with the <em>fastest</em> ones having more of a right skew than a left skew in log space. The widths of the distributions, however, are broadly similar.</li>
</ul>
<ul>
<li>The binned scatter plot of <em>trip_duration</em> vs <em>total_travel_time</em> (lower left corner) reveals that there are numerous ouliers towards <em>trip_durations</em>. Interestingly, almost all of those appear below 2000 s (about 0.55 h) of <em>total_travel_time</em>. We will study those trips in more detail below.</li>
</ul>
<ul>
<li>The direct distances (as the crow flies) are longer than the <em>fastest</em> distances, but not by that much. By and large, the direct <em>dist*ance is a pretty good proxy for the actual, *fastest</em> distance according to the binned scatter plot. There are (rare) outliers towards longer direct <em>dist</em>ances, which indicates potentially problematic data entries.</li>
</ul>
<p>What about the <em>speed</em>? Comparing our original <em>speed</em> estimate to the <em>fastest_speed</em> from the OSRM data should give us an idea how realistic the values of the former feature are.</p>
<p>For this figure, in the kernel-density plot the <em>fastest</em> values are in blue and the red line in the binned scatter plot has slope equal one:</p>
<figure class="highlight plain"><figcaption><span>eval</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">p1 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(speed)) +</span><br><span class="line"></span><br><span class="line">  geom_density(fill &#x3D; &quot;red&quot;, alpha &#x3D; 0.5) +</span><br><span class="line"></span><br><span class="line">  geom_density(aes(fastest_speed), fill &#x3D; &quot;blue&quot;, alpha &#x3D; 0.5) +</span><br><span class="line"></span><br><span class="line">  coord_cartesian(xlim &#x3D; c(0, 80))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p2 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(speed, fastest_speed)) +</span><br><span class="line"></span><br><span class="line">  geom_bin2d(bins &#x3D; c(50,50)) +</span><br><span class="line"></span><br><span class="line">  geom_abline(intercept &#x3D; 0, slope &#x3D; 1, colour &#x3D; &quot;red&quot;) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">layout &lt;- matrix(c(1,2),1,2,byrow&#x3D;TRUE)</span><br><span class="line"></span><br><span class="line">multiplot(p1, p2, layout&#x3D;layout)</span><br><span class="line"></span><br><span class="line">p1 &lt;- 1; p2 &lt;- 1</span><br></pre></td></tr></table></figure>





<p>Here we find several effects:</p>
<ul>
<li>By not accounting for traffic, our <em>fastest</em> speeds are always above 20 km/h (12 mph), a value that is not frequently reached in our actual data.</li>
</ul>
<ul>
<li>The theoretical speed disribution shows several peaks, most prominently a very sharp one between 25 and 30 km/h (15 - 18 mph) and a broader one around 40 km/h (25 mph). Without knowing very much about the traffic management in NYC I would assume that they correspond to zones of different speed limits and their linear combinations.</li>
</ul>
<ul>
<li>There is no correlation between <em>speed</em> and <em>fastest_speed</em>. This reflects the large number of delays in the scatter plot of <em>trip_duration</em> vs <em>total_travel_time</em> which we will study in a separate step.</li>
</ul>
<p>At face value, the impact of the number of <em>turns</em> on the <em>total_travel_time</em> is very similar for <em>left_turns</em> and <em>right_turns</em>. A main reason behind this will be that the <em>total_travel_time</em> increases with increasing <em>number_of_steps</em> of any kind and that the number of <em>turns</em> is of course correlated with the <em>number_of_steps</em>. We will learn more from the percentage of turns per trip, which we will investigate in a moment. From these plots we find the following results:</p>
<figure class="highlight plain"><figcaption><span>eval</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">p1 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(factor(left_turns), total_travel_time, color &#x3D; factor(left_turns))) +</span><br><span class="line"></span><br><span class="line">  geom_boxplot() +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Number of left turns&quot;) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p2 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(factor(right_turns), total_travel_time, color &#x3D; factor(right_turns))) +</span><br><span class="line"></span><br><span class="line">  geom_boxplot() +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Number of right turns&quot;) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p3 &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(factor(turns), total_travel_time, color &#x3D; factor(turns))) +</span><br><span class="line"></span><br><span class="line">  geom_boxplot() +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Total number of turns&quot;) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">layout &lt;- matrix(c(1,2,3,3),2,2,byrow&#x3D;TRUE)</span><br><span class="line"></span><br><span class="line">multiplot(p1, p2, p3, layout&#x3D;layout)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1 &lt;- 1; p2 &lt;- 1; p3 &lt;- 1</span><br></pre></td></tr></table></figure>



<ul>
<li>There is a “NA” entry here which is caused by a single observation (“id3008062”) which is missing from the <em>fastest_routes</em> data. This is a very minor issue without any practical impact on our predictions, but it’s good to be aware of this “NA” entry. It <a href="https://www.kaggle.com/oscarleo/new-york-city-taxi-with-osrm/discussion/37337" target="_blank" rel="noopener">turns out</a> that OSRM does not provide a route for this data point.</li>
</ul>
<ul>
<li>Right turns and slightly more frequent than left turns (up to 21 vs 19).</li>
</ul>
<ul>
<li>For the total number of <em>turns</em> there is a first maximum in the median <em>total_travel_time</em> at 13 turns, after which the median declines somewhat.</li>
</ul>
<p>Now let’s move on to the turn percentages:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">foo &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(!is.na(left_turns)) %&gt;%</span><br><span class="line"></span><br><span class="line">  mutate(left_frac &#x3D; left_turns&#x2F;number_of_steps,</span><br><span class="line"></span><br><span class="line">         right_frac &#x3D; right_turns&#x2F;number_of_steps)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1 &lt;- foo %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(left_frac)) +</span><br><span class="line"></span><br><span class="line">  geom_histogram(bins &#x3D; 20, fill &#x3D; &quot;red&quot;) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Left turns &#x2F; all steps&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p2 &lt;- foo %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(right_frac)) +</span><br><span class="line"></span><br><span class="line">  geom_histogram(bins &#x3D; 20, fill &#x3D; &quot;red&quot;) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Right turns &#x2F; all steps&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p3 &lt;- foo %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(left_frac, total_travel_time)) +</span><br><span class="line"></span><br><span class="line">  geom_bin2d(bins &#x3D; c(40,40)) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Left turns &#x2F; all steps&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p4 &lt;- foo %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(right_frac, total_travel_time)) +</span><br><span class="line"></span><br><span class="line">  geom_bin2d(bins &#x3D; c(40,40)) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Right turns &#x2F; all steps&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p5 &lt;- foo %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(left_frac, fastest_speed)) +</span><br><span class="line"></span><br><span class="line">  geom_bin2d(bins &#x3D; c(40,40)) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Left turns &#x2F; all steps&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p6 &lt;- foo %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(right_frac, fastest_speed)) +</span><br><span class="line"></span><br><span class="line">  geom_bin2d(bins &#x3D; c(40,40)) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Right turns &#x2F; all steps&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">layout &lt;- matrix(c(1,2,3,4,5,6),3,2,byrow&#x3D;TRUE)</span><br><span class="line"></span><br><span class="line">multiplot(p1, p2, p3, p4, p5, p6, layout&#x3D;layout)</span><br><span class="line"></span><br><span class="line">p1 &lt;- 1; p2 &lt;- 1; p3 &lt;- 1; p4 &lt;- 1; p5 &lt;- 1; p6 &lt;- 1; foo &lt;- 1</span><br></pre></td></tr></table></figure>



<p>We find:</p>
<ul>
<li>Right turns are indeed somewhat more frequent than left turns. Both kind of turns make up mostly less than 50% of all travel maneuvers but can reach 80%. There is a significant number of trips without any turns at all.</li>
</ul>
<ul>
<li>A higher fraction of turns does <em>not</em> correlate with higher <em>total_travel_times</em>. Instead, the longest times are reached at around 1/3 of maneuvers being turns.</li>
</ul>
<ul>
<li>On the other hand, the <em>fastest_speed</em> (i.e. <em>total_distance</em> / <em>total_travel_time</em>) shows indications for lower average values for larger number of <em>left_turns</em> for the percentage range of 50% to 80%. Notably, there is no such obvious impact for the number of <em>right_turns</em> up until 75%. Thus, excessive numbers of <em>left</em> turns really appear to be slowing down our travel speed.</li>
</ul>
<h3 id="trip-duration-vs-total-travel-time-a-look-at-curious-delays"><a href="#trip-duration-vs-total-travel-time-a-look-at-curious-delays" class="headerlink" title="trip_duration vs total_travel_time - a look at curious delays"></a><em>trip_duration</em> vs <em>total_travel_time</em> - a look at curious delays</h3><p>In this section we will compare the OSRM <em>total_travel_time</em> to the taxi <em>trip_duration</em> in our original data. We will specifically focus on understanding those curious cases that suggest significant delays in our data.</p>
<p>Here we plot the a scatter plot of the two timing features colour-coded by the percentage of left turns in the the OSRM route (the solid red line has again a slope of 1):</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">train %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(trip_duration, total_travel_time, color &#x3D; left_turns &#x2F; number_of_steps)) +</span><br><span class="line"></span><br><span class="line">  geom_point(alpha &#x3D; 0.3) +</span><br><span class="line"></span><br><span class="line">  geom_abline(intercept &#x3D; 0, slope &#x3D; 1, colour &#x3D; &quot;red&quot;) +</span><br><span class="line"></span><br><span class="line">  scale_colour_gradient(low &#x3D; &quot;blue&quot;, high &#x3D; &quot;red&quot;) +</span><br><span class="line"></span><br><span class="line">  scale_x_log10() +</span><br><span class="line"></span><br><span class="line">  scale_y_log10() +</span><br><span class="line"></span><br><span class="line">  geom_hline(yintercept &#x3D; c(50,2000), linetype &#x3D; 2) +</span><br><span class="line"></span><br><span class="line">  labs(color &#x3D; &quot;Left turns [%]&quot;)</span><br></pre></td></tr></table></figure>



<p>Note the double-log axes.</p>
<p>We find:</p>
<ul>
<li>There is a population of data point where the <em>trip_duration</em> (the actual timing of the taxi ride) is lower than the <em>total_travel_time</em> based on the fastest OSRM route. These differences can be significant for the trips that take less than 1000 s (i.e. about 17 min) on the fastest route but become less severe for rides longer than that.</li>
</ul>
<ul>
<li>There are no “fastest” routes with more than 10 ks <em>total_travel_time</em>. The maximum in the cleaned sample is at about 5000 s or 1.5 h. Almost all of the significant long-delay outliers in <em>trip_duration</em> (indicated by the horizontal dashed lines) lie in the range of 100 - 2000 s <em>total_travel_time</em> and extend beyond 10 ks <em>trip_duration</em>.</li>
</ul>
<ul>
<li>There appears to be a tendency for longer trips (especially in <em>total_travel_time</em>) to contain a higher fraction of <em>left_turns</em>. However, this apparent effect might be due to the shortest rides containing no turns and longer rides (above 1 min) including an average number of turns. In any case, within the long-delay outliers there is no obvious impact of the percentage of <em>left_turns</em>.</li>
</ul>
<p>The most prominent outliers only make up a very small percentage of the overall rides:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(total_travel_time &gt; 50 &amp; total_travel_time &lt; 2000) %&gt;%</span><br><span class="line"></span><br><span class="line">  mutate(delay &#x3D; trip_duration &gt; 1e4) %&gt;%</span><br><span class="line"></span><br><span class="line">  group_by(delay) %&gt;%</span><br><span class="line"></span><br><span class="line">  count()</span><br></pre></td></tr></table></figure>



<p>We will briefly examine those data points using a comparison of relative frequencies in bar plots and density overlays:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">foo &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(total_travel_time &gt; 50 &amp; total_travel_time &lt; 2000) %&gt;%</span><br><span class="line"></span><br><span class="line">  mutate(delay &#x3D; trip_duration &gt; 1e4)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1 &lt;- foo %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(vendor_id, group &#x3D; delay)) +</span><br><span class="line"></span><br><span class="line">  geom_bar(aes(y &#x3D; ..prop.., fill &#x3D; factor(..x..)), stat&#x3D;&quot;count&quot;) + </span><br><span class="line"></span><br><span class="line">  scale_y_continuous(labels&#x3D;scales::percent) +</span><br><span class="line"></span><br><span class="line">  ylab(&quot;relative frequencies&quot;) +</span><br><span class="line"></span><br><span class="line">  facet_grid(~delay) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p2 &lt;- foo %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(jfk_trip, group &#x3D; delay)) +</span><br><span class="line"></span><br><span class="line">  geom_bar(aes(y &#x3D; ..prop.., fill &#x3D; factor(..x..)), stat&#x3D;&quot;count&quot;) + </span><br><span class="line"></span><br><span class="line">  scale_y_continuous(labels&#x3D;scales::percent) +</span><br><span class="line"></span><br><span class="line">  ylab(&quot;relative frequencies&quot;) +</span><br><span class="line"></span><br><span class="line">  facet_grid(~delay) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p3 &lt;- foo %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(lg_trip, group &#x3D; delay)) +</span><br><span class="line"></span><br><span class="line">  geom_bar(aes(y &#x3D; ..prop.., fill &#x3D; factor(..x..)), stat&#x3D;&quot;count&quot;) + </span><br><span class="line"></span><br><span class="line">  scale_y_continuous(labels&#x3D;scales::percent) +</span><br><span class="line"></span><br><span class="line">  ylab(&quot;relative frequencies&quot;) +</span><br><span class="line"></span><br><span class="line">  facet_grid(~delay) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p4 &lt;- foo %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(work, group &#x3D; delay)) +</span><br><span class="line"></span><br><span class="line">  geom_bar(aes(y &#x3D; ..prop.., fill &#x3D; factor(..x..)), stat&#x3D;&quot;count&quot;) + </span><br><span class="line"></span><br><span class="line">  scale_y_continuous(labels&#x3D;scales::percent) +</span><br><span class="line"></span><br><span class="line">  ylab(&quot;relative frequencies&quot;) +</span><br><span class="line"></span><br><span class="line">  facet_grid(~delay) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p5 &lt;- foo %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(total_distance, fill &#x3D; delay)) +</span><br><span class="line"></span><br><span class="line">  geom_density(alpha &#x3D; 0.5)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">layout &lt;- matrix(c(1,2,3,4,5,5),2,3,byrow&#x3D;TRUE)</span><br><span class="line"></span><br><span class="line">multiplot(p1, p2, p3, p4, p5, layout&#x3D;layout)</span><br><span class="line"></span><br><span class="line">p1 &lt;- 1; p2 &lt;- 1; p3 &lt;- 1; p4 &lt;- 1; p5 &lt;- 1; p6 &lt;- 1</span><br></pre></td></tr></table></figure>



<p>Here the facets (true vs false) refer to the observations being part of the long-delay group or not.</p>
<p>We find:</p>
<ul>
<li>Almost all long delays happen for the taxis of vendor 2, even though vendor 2 has only a slightly higher percentage of rides overall. This discrepancy is definitely significant enough to explain most of the effect.</li>
</ul>
<ul>
<li>Another interesting fact is that in the long-delay sample the fraction of JFK trips is significantly higher, and the fraction of La Guardia trips is slightly higher, than in the general population. We could hypothesise that for an airport journey the <em>trip_duration</em> might include the waiting time while queuing for passengers. JFK trips make up almost 30% of the long-delay trips (60 out of 207).</li>
</ul>
<ul>
<li>The percentage of delays during <em>work</em> hours is slightly higher but not with practical significance.</li>
</ul>
<ul>
<li>Furthermore, in the long-delay distribution the long distances are clearly favoured over shorter ones. Remember that here we are only comparing trips within the same bracket of <em>total_travel_time</em> (50 - 2000 s).</li>
</ul>
<ul>
<li>In addition, not shown here is the observation that long delays appear to be slightly more frequent on Tuesdays or in January and March; compared to Wednesday and Thursdays or February. However, considering the number of categories and that the deviations at most reach 5 percentage points these effect might be random.</li>
</ul>
<p>Another curious group of outliers can be found in the lower middle portion of the <em>trip_duration</em> vs <em>total_travel_time</em> plot. Here we encode the colour of the trips by their <em>vendor_id</em>, to further highlight the impact of vendor 2 on the long-duration outliers on the top right and the few ones on the bottom right:</p>
<figure class="highlight plain"><figcaption><span>eval</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">train %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(trip_duration, total_travel_time, color &#x3D; vendor_id)) +</span><br><span class="line"></span><br><span class="line">  geom_point(alpha &#x3D; 0.3) +</span><br><span class="line"></span><br><span class="line">  geom_abline(intercept &#x3D; 0, slope &#x3D; 1, colour &#x3D; &quot;red&quot;) +</span><br><span class="line"></span><br><span class="line">  scale_x_log10() +</span><br><span class="line"></span><br><span class="line">  scale_y_log10() +</span><br><span class="line"></span><br><span class="line">  geom_hline(yintercept &#x3D; c(10), linetype &#x3D; 2) +</span><br><span class="line"></span><br><span class="line">  geom_vline(xintercept &#x3D; c(600,5000), linetype &#x3D; 2)</span><br></pre></td></tr></table></figure>



<p>The second group of outliers lies at <em>total_travel_time &lt; 10</em> and <em>trip_duration = 600 - 4000</em>; units in seconds as usual. See the hidden figure or fig 26. Therefore, those are trips over very short distances that should have only taken a few seconds, but in our data they took between 10 minutes and 1.4 hours. In a way, there is a continuum of data points in the lower left to middle part of the plot, but the ones over 10 minutes show another peak in density:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(total_travel_time &lt; 10 &amp; trip_duration &lt; 10000) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(trip_duration)) +</span><br><span class="line"></span><br><span class="line">  geom_density(fill &#x3D; &quot;red&quot;) +</span><br><span class="line"></span><br><span class="line">  geom_vline(xintercept &#x3D; c(600,5000), linetype &#x3D; 2) +</span><br><span class="line"></span><br><span class="line">  scale_x_log10()</span><br></pre></td></tr></table></figure>





<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">foo &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(total_travel_time &lt; 10) %&gt;%</span><br><span class="line"></span><br><span class="line">  mutate(delay &#x3D; trip_duration &gt; 600)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1 &lt;- foo %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(vendor_id, group &#x3D; delay)) +</span><br><span class="line"></span><br><span class="line">  geom_bar(aes(y &#x3D; ..prop.., fill &#x3D; factor(..x..)), stat&#x3D;&quot;count&quot;) + </span><br><span class="line"></span><br><span class="line">  scale_y_continuous(labels&#x3D;scales::percent) +</span><br><span class="line"></span><br><span class="line">  ylab(&quot;relative frequencies&quot;) +</span><br><span class="line"></span><br><span class="line">  facet_grid(~delay) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p2 &lt;- foo %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(wday, group &#x3D; delay)) +</span><br><span class="line"></span><br><span class="line">  geom_bar(aes(y &#x3D; ..prop.., fill &#x3D; factor(..x..)), stat&#x3D;&quot;count&quot;) + </span><br><span class="line"></span><br><span class="line">  scale_y_continuous(labels&#x3D;scales::percent) +</span><br><span class="line"></span><br><span class="line">  ylab(&quot;relative frequencies&quot;) +</span><br><span class="line"></span><br><span class="line">  facet_grid(~delay) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p3 &lt;- foo %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(passenger_count, group &#x3D; delay)) +</span><br><span class="line"></span><br><span class="line">  geom_bar(aes(y &#x3D; ..prop.., fill &#x3D; factor(..x..)), stat&#x3D;&quot;count&quot;) + </span><br><span class="line"></span><br><span class="line">  scale_y_continuous(labels&#x3D;scales::percent) +</span><br><span class="line"></span><br><span class="line">  ylab(&quot;relative frequencies&quot;) +</span><br><span class="line"></span><br><span class="line">  facet_grid(~delay) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p4 &lt;- foo %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(total_distance, fill &#x3D; delay)) +</span><br><span class="line"></span><br><span class="line">  geom_density(alpha &#x3D; 0.5) +</span><br><span class="line"></span><br><span class="line">  coord_cartesian(xlim &#x3D; c(0,100))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">layout &lt;- matrix(c(1,1,2,2,2,2,3,3,3,4,4,4),2,6,byrow&#x3D;TRUE)</span><br><span class="line"></span><br><span class="line">multiplot(p1, p2, p3, p4, layout&#x3D;layout)</span><br><span class="line"></span><br><span class="line">p1 &lt;- 1; p2 &lt;- 1; p3 &lt;- 1; p4 &lt;- 1; p5 &lt;- 1; p6 &lt;- 1</span><br></pre></td></tr></table></figure>



<p>We find:</p>
<ul>
<li>Again, vendor 2 has systematically longer <em>trip_durations</em> than vendor 1.</li>
</ul>
<ul>
<li>Delays of this second kind appear to be more frequent on weekends, compared to the overall distribution.</li>
</ul>
<ul>
<li>The number of passengers is higher too for these delays, so maybe we are counting the time it takes them (and their luggage) to get in and out of the taxi?</li>
</ul>
<ul>
<li>The distances for the delays are again longer, but notice the different scale here. Distances of less than 100 m should not take more than 10 min.</li>
</ul>
<ul>
<li>Not shown: <em>jfk_trip</em> and <em>lg_trip</em> have no impact here because the overall distances are so short.</li>
</ul>
<p><strong>In summary</strong>, we find that the <em>vendor_id</em> has distinguishing power for the two outlier groups, with airport trips very likely to contribute to the long-delay outliers. Other factors like <em>wday</em> or <em>passenger_count</em> might contribute additional signal.</p>
<h1 id="Correlations-overview"><a href="#Correlations-overview" class="headerlink" title="Correlations overview"></a>Correlations overview</h1><p>After engineering new features and before starting the modelling, we will visualise the relations between our parameters using a <em>correlation matrix</em>. For this, we need to change all the input features into a numerical format. The visualisation uses the <em>corrplot</em> function from the eponymous package. <em>Corrplot</em> gives us great flexibility in manipulating the style of our plot.</p>
<p>What we see below, are the colour-coded <em>correlation coefficients</em> for each combination of two features. In simplest terms: this shows whether two features are connected so that one changes with a predictable trend if you change the other. The closer this coefficient is to zero the weaker is the correlation. Both 1 and -1 are the ideal cases of perfect correlation and anti-correlation (dark blue and dark red in the plots below).</p>
<p>Here, we are of course interested if and how strongly our features correlate with the <em>trip_duration</em>, the prediction of which is the ultimate goal of this challenge. But we also want to know whether our potential predictors are <em>correlated among each other</em>, so that we can reduce the collinearity in our data set and improve the robustness of our prediction:</p>
<figure class="highlight plain"><figcaption><span>eval</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">train %&gt;%</span><br><span class="line"></span><br><span class="line">  select(-id, -pickup_datetime, -dropoff_datetime, -jfk_dist_pick,</span><br><span class="line"></span><br><span class="line">         -jfk_dist_drop, -lg_dist_pick, -lg_dist_drop, -date) %&gt;%</span><br><span class="line"></span><br><span class="line">  mutate(passenger_count &#x3D; as.integer(passenger_count),</span><br><span class="line"></span><br><span class="line">         vendor_id &#x3D; as.integer(vendor_id),</span><br><span class="line"></span><br><span class="line">         store_and_fwd_flag &#x3D; as.integer(as.factor(store_and_fwd_flag)),</span><br><span class="line"></span><br><span class="line">         jfk_trip &#x3D; as.integer(jfk_trip),</span><br><span class="line"></span><br><span class="line">         wday &#x3D; as.integer(wday),</span><br><span class="line"></span><br><span class="line">         month &#x3D; as.integer(month),</span><br><span class="line"></span><br><span class="line">         work &#x3D; as.integer(work),</span><br><span class="line"></span><br><span class="line">         lg_trip &#x3D; as.integer(lg_trip),</span><br><span class="line"></span><br><span class="line">         blizzard &#x3D; as.integer(blizzard),</span><br><span class="line"></span><br><span class="line">         has_snow &#x3D; as.integer(has_snow),</span><br><span class="line"></span><br><span class="line">         has_rain &#x3D; as.integer(has_rain)) %&gt;%</span><br><span class="line"></span><br><span class="line">  select(trip_duration, speed, everything()) %&gt;%</span><br><span class="line"></span><br><span class="line">  cor(use&#x3D;&quot;complete.obs&quot;, method &#x3D; &quot;spearman&quot;) %&gt;%</span><br><span class="line"></span><br><span class="line">  corrplot(type&#x3D;&quot;lower&quot;, method&#x3D;&quot;circle&quot;, diag&#x3D;FALSE)</span><br></pre></td></tr></table></figure>



<p>If we remove the features with little to no significant impact on other features that are not directly related then our (effective) correlation matrix looks like this. In this plot (and in the hidden figure) the fading serves the purpose that everything that would be hard to see is not worth seeing:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">foo &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  select(-id, -pickup_datetime, -dropoff_datetime, -jfk_dist_pick,</span><br><span class="line"></span><br><span class="line">         -jfk_dist_drop, -lg_dist_pick, -lg_dist_drop, -date,</span><br><span class="line"></span><br><span class="line">         -store_and_fwd_flag, -hour, -rain, -s_fall, -all_precip,</span><br><span class="line"></span><br><span class="line">         -has_rain, -s_depth, -min_temp, -max_temp,</span><br><span class="line"></span><br><span class="line">         -wday, -right_turns, -turns, -fast_speed_trip) %&gt;%</span><br><span class="line"></span><br><span class="line">  mutate(passenger_count &#x3D; as.integer(passenger_count),</span><br><span class="line"></span><br><span class="line">         vendor_id &#x3D; as.integer(vendor_id),</span><br><span class="line"></span><br><span class="line">         jfk_trip &#x3D; as.integer(jfk_trip),</span><br><span class="line"></span><br><span class="line">         lg_trip &#x3D; as.integer(lg_trip),</span><br><span class="line"></span><br><span class="line">         month &#x3D; as.integer(month),</span><br><span class="line"></span><br><span class="line">         work &#x3D; as.integer(work),</span><br><span class="line"></span><br><span class="line">         blizzard &#x3D; as.integer(blizzard),</span><br><span class="line"></span><br><span class="line">         has_snow &#x3D; as.integer(has_snow)) %&gt;%</span><br><span class="line"></span><br><span class="line">  select(trip_duration, speed, everything())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">foo %&gt;%</span><br><span class="line"></span><br><span class="line">  cor(use&#x3D;&quot;complete.obs&quot;, method &#x3D; &quot;spearman&quot;) %&gt;%</span><br><span class="line"></span><br><span class="line">  corrplot(type&#x3D;&quot;lower&quot;, method&#x3D;&quot;circle&quot;, diag&#x3D;FALSE)</span><br><span class="line"></span><br><span class="line">foo &lt;- 1</span><br></pre></td></tr></table></figure>



<p>We find:</p>
<ul>
<li>The strongest correlations with the <em>trip_duration</em> are seen for the direct <em>dist*ance as well as the *total_distance</em> and <em>total_travel_time</em> derived from the OSRM data. As we have already seen above, the distances are highly correlated with one another and with the <em>total_travel_time</em>. Also the number of turns, presumably mostly via the <em>number_of_steps</em>, are having an impact on the <em>trip_duration</em>.</li>
</ul>
<ul>
<li>Another effect on the <em>trip_duration</em> can bee seen for our engineered features <em>jfk_trip</em> and <em>lg_trip</em>; indicating journeys to either airport. A similar statement is true for the average <em>speed</em> and airport travel.</li>
</ul>
<ul>
<li>The pickup and dropoff coordinates are correlated, which is a bit puzzling but might be partly explained by the shape of Manhattan stretching from south-west to north-east. Another part of the explanation might be short trips within lower or upper Manhattan only.</li>
</ul>
<ul>
<li><em>vendor_id</em> is correlated with <em>passenger_count</em> because of vendor 2 having all the (five) trips with more than 6 passengers.</li>
</ul>
<ul>
<li>Among the <em>weather</em> data (mostly seen in the full hidden plot), the minimum and maximum temperatures show a strong correlation with each other and the <em>month</em> of the year, which is intuitively understandable. Also the different ways of measuring precipitation are naturally correlated with each other and, in case of <em>snow</em>, with the <em>month</em>.</li>
</ul>
<p>We should be able to see these relations in our model.</p>
<h1 id="An-excursion-into-classification"><a href="#An-excursion-into-classification" class="headerlink" title="An excursion into classification"></a>An excursion into classification</h1><p>Our challenge is by nature a <em>regression problem:</em> we want to predict a continous variable, <em>trip_duration</em> from a set of features. In this kernel we will continue to treat it as a regression problem, but in this section I want to present a brief excursion into the possibility of turning it into a <em>classification problem</em>.</p>
<p>In a classification context our target variable can only take a (small) number of discrete values. Often, we are faced with a binary outcome, for instance “Survived vs Not Survived” in the popular <a href="https://www.kaggle.com/c/titanic" target="_blank" rel="noopener">Titanic challenge</a>. Here we want to examine which factors contribute to <em>shorter or longer trip_durations.</em></p>
<p>Recall the distribution of <em>trip_durations</em> from the beginning of this notebook, now cleaned with the more spurious trips removed. Here we separate it into three parts: short, middle, and long duration:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">train_group &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  mutate(tgroup &#x3D; case_when(trip_duration &lt; 3e2 ~ &quot;fast&quot;,</span><br><span class="line"></span><br><span class="line">                            trip_duration &gt;&#x3D; 3e2 &amp; trip_duration &lt;&#x3D; 1.6e3 ~ &quot;mid&quot;,</span><br><span class="line"></span><br><span class="line">                            trip_duration &gt; 1.6e3 ~ &quot;slow&quot;))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">train_group %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(trip_duration, fill &#x3D; tgroup)) +</span><br><span class="line"></span><br><span class="line">  geom_histogram(bins &#x3D; 300) +</span><br><span class="line"></span><br><span class="line">  scale_x_log10() +</span><br><span class="line"></span><br><span class="line">  scale_y_sqrt()</span><br></pre></td></tr></table></figure>



<p>(Ignore the apparent spikes caused by the binning resolution.)</p>
<p>For the purpose of this excercise, we are not interested in the middle bit. Our aim is to compare the properties of the fast vs slow trips.</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">train_group &lt;- train_group %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(tgroup !&#x3D; &quot;mid&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1 &lt;- train_group %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(wday, fill &#x3D; tgroup)) +</span><br><span class="line"></span><br><span class="line">  geom_bar(position &#x3D; &quot;fill&quot;) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">p2 &lt;- train_group %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(month, fill &#x3D; tgroup)) +</span><br><span class="line"></span><br><span class="line">  geom_bar(position &#x3D; &quot;fill&quot;) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p3 &lt;- train_group %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(hour, fill &#x3D; tgroup)) +</span><br><span class="line"></span><br><span class="line">  geom_bar(position &#x3D; &quot;fill&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p4 &lt;- train_group %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(jfk_trip, fill &#x3D; tgroup)) +</span><br><span class="line"></span><br><span class="line">  geom_bar(position &#x3D; &quot;fill&quot;) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p5 &lt;- train_group %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(lg_trip, fill &#x3D; tgroup)) +</span><br><span class="line"></span><br><span class="line">  geom_bar(position &#x3D; &quot;fill&quot;) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p6 &lt;- train_group %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(blizzard, fill &#x3D; tgroup)) +</span><br><span class="line"></span><br><span class="line">  geom_bar(position &#x3D; &quot;fill&quot;) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p7 &lt;- train_group %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(work, fill &#x3D; tgroup)) +</span><br><span class="line"></span><br><span class="line">  geom_bar(position &#x3D; &quot;fill&quot;) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">layout &lt;- matrix(c(1,1,2,2,3,3,3,3,4,5,6,7),3,4,byrow&#x3D;TRUE)</span><br><span class="line"></span><br><span class="line">multiplot(p1, p2, p3, p4, p5, p6, p7, layout&#x3D;layout)</span><br><span class="line"></span><br><span class="line">p1 &lt;- 1; p2 &lt;- 1; p3 &lt;- 1; p4 &lt;- 1; p5 &lt;- 1; p6 &lt;- 1; p7 &lt;- 1</span><br></pre></td></tr></table></figure>



<p>We find:</p>
<ul>
<li>Our airport features, <em>jfk_trip</em> and <em>lg_trip</em>, behave as expected and are predominantly slow trips. Also the <em>blizzard</em> feature shows a promising increase in slow trips.</li>
</ul>
<ul>
<li>Throughout the week, there is a notable difference between the weekend and the weekdays. It might be worth to encode the <em>wday</em> feature according to this trend. We see that the <em>monthly</em> trend already shows a gradually increasing “slow” proportion.</li>
</ul>
<ul>
<li>During the day, we find again the difference between night and (working) day that we had seen in previously in the scatter plot plus heatmap and which is partly resolved in our engineered <em>work</em> feature.</li>
</ul>
<p>For a visualisation of the <em>pickup</em> coordinates for the <em>fast</em> vs <em>slow</em> rides we build another map using the great <em>leaflet</em> package. Those maps don’t require external API calls and run fully contained in a Kaggle kernel. We visualise our two groups of trips using a <em>heatmap</em> which we add through tools in the <em>leaflet.extras</em> package.</p>
<p>In this <em>leaflet</em> visualisation, you can toggle and overlay the <em>fast</em> vs <em>slow</em> rides independently, and also choose a dark vs light background map (in addition to a free zoom and pan). These layers are easy to define within a leaflet object; have a look at the code to see how concise the <em>addLayersControl</em> element is. Zoom in to see street-level resolution:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">pick_fast &lt;- train_group %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(tgroup &#x3D;&#x3D; &quot;fast&quot;) %&gt;%</span><br><span class="line"></span><br><span class="line">  select(long &#x3D; pickup_longitude, lat &#x3D; pickup_latitude)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pick_slow &lt;- train_group %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(tgroup &#x3D;&#x3D; &quot;slow&quot;) %&gt;%</span><br><span class="line"></span><br><span class="line">  select(long &#x3D; pickup_longitude, lat &#x3D; pickup_latitude)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">leaflet(pick_fast) %&gt;% </span><br><span class="line"></span><br><span class="line">  addProviderTiles(providers$CartoDB.DarkMatter, group &#x3D; &quot;Dark map&quot;) %&gt;%</span><br><span class="line"></span><br><span class="line">  addProviderTiles(providers$CartoDB.Positron, group &#x3D; &quot;Light map&quot;) %&gt;%</span><br><span class="line"></span><br><span class="line">  addScaleBar() %&gt;%</span><br><span class="line"></span><br><span class="line">  setView(-73.95, 40.74, zoom &#x3D; 11) %&gt;%</span><br><span class="line"></span><br><span class="line">  addHeatmap(max &#x3D; 140, gradient &#x3D; &quot;Reds&quot;, radius &#x3D; 12,</span><br><span class="line"></span><br><span class="line">             minOpacity &#x3D; 0.15, blur &#x3D; 15, group &#x3D; &quot;Fast trips&quot;) %&gt;%</span><br><span class="line"></span><br><span class="line">  addHeatmap(lng &#x3D; pick_slow$long, lat &#x3D; pick_slow$lat,</span><br><span class="line"></span><br><span class="line">             max &#x3D; 100, gradient &#x3D; &quot;Blues&quot;, radius &#x3D; 12, </span><br><span class="line"></span><br><span class="line">             minOpacity &#x3D; 0.25, blur &#x3D; 15, group &#x3D; &quot;Slow trips&quot;) %&gt;%</span><br><span class="line"></span><br><span class="line">  addLayersControl(</span><br><span class="line"></span><br><span class="line">    baseGroups &#x3D; c(&quot;Dark Map&quot;, &quot;Light map&quot;),</span><br><span class="line"></span><br><span class="line">    overlayGroups &#x3D; c(&quot;Fast trips&quot;, &quot;Slow trips&quot;),</span><br><span class="line"></span><br><span class="line">    options &#x3D; layersControlOptions(collapsed &#x3D; FALSE)</span><br><span class="line"></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>



<p>We find:</p>
<ul>
<li>As expected, the airports stand out as origins of <em>slow</em> rides. Interestingly, a similar observations can be made for the areas surrounding the airports.</li>
</ul>
<ul>
<li>There is a number of <em>fast</em> trip pickups just accross the Hudson river and near Newark airport in Jersey. </li>
</ul>
<ul>
<li>Interestingly, except for the airport locations the <em>fast</em> trip pickups appear to be more spatially extended than the slow ones.</li>
</ul>
<p>For a different kind of visualisation of your classification problem I would like to illustrate an <em>alluvial plot</em>. Made available through the <a href=""><em>alluvial</em> package</a>, those plots are a kind of mix between a flow chart and a bar plot and they show how the target categories relate to various discrete features.</p>
<p>I would like to thank <a href="https://www.kaggle.com/retrospectprospect" target="_blank" rel="noopener">retrospectprospect</a> for introducing me to alluvial plots in their very elegant <a href="https://www.kaggle.com/retrospectprospect/titanic-machine-learning-from-eda-to-xgb" target="_blank" rel="noopener">EDA kernel</a> for the <a href="https://www.kaggle.com/c/titanic" target="_blank" rel="noopener">Titanic</a> challenge! The same user also has shared an informative and concise <a href="https://www.kaggle.com/retrospectprospect/nyc-taxi-trip-duration-eda-to-xgb/" target="_blank" rel="noopener">kernel</a> in this competition, and if you haven’t seen it yet then I definitely recommend you to check it out.</p>
<p>Without further ado, here is the plot:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">allu_train &lt;- train_group %&gt;%</span><br><span class="line"></span><br><span class="line">  group_by(tgroup, work, wday, jfk_trip) %&gt;%</span><br><span class="line"></span><br><span class="line">  count() %&gt;%</span><br><span class="line"></span><br><span class="line">  ungroup</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">alluvial(allu_train %&gt;% select(-n),</span><br><span class="line"></span><br><span class="line">         freq&#x3D;allu_train$n, border&#x3D;NA,</span><br><span class="line"></span><br><span class="line">         col&#x3D;ifelse(allu_train$tgroup &#x3D;&#x3D; &quot;fast&quot;, &quot;red&quot;, &quot;blue&quot;),</span><br><span class="line"></span><br><span class="line">         cex&#x3D;0.75,</span><br><span class="line"></span><br><span class="line">         hide &#x3D; allu_train$n &lt; 150,</span><br><span class="line"></span><br><span class="line">         ordering &#x3D; list(</span><br><span class="line"></span><br><span class="line">           order(allu_train$tgroup&#x3D;&#x3D;&quot;fast&quot;),</span><br><span class="line"></span><br><span class="line">           NULL,</span><br><span class="line"></span><br><span class="line">           NULL,</span><br><span class="line"></span><br><span class="line">           NULL))</span><br></pre></td></tr></table></figure>



<p>In this plot, the vertical sizes of the blocks and the widths of the stripes (called “alluvia”) are proportional to the frequency. We decided to <em>hide</em> the alluvia with the lowest frequencies using the parameter of the same name. Within a category block you can re-<em>order</em> the vertical layering of the alluvia to emphasise certain aspects of your data set. Here, we see nicely how the <em>fast</em> vs <em>slow</em> groups fan out into the different categories.</p>
<p>We find:</p>
<ul>
<li>Outside of work hours (<em>work == FALSE</em>) the majority of trips are <em>fast</em>, which we can see from the larger proportion of red alluvia.</li>
</ul>
<ul>
<li>In terms of <em>wday</em>, Sat and Sun contain a larger proportion of <em>fast</em> trips than the weekdays. In addition, Sat and Sun have of course no contribution to <em>work == TRUE</em>, since no alluvia connect the corresponding boxes. This is a useful consistency check.</li>
</ul>
<ul>
<li>Airport trips are almost entirely <em>slow</em> ones. We removed the few thin alluvias (using the <em>hide</em> parameter) because they were hard to see in the first place.</li>
</ul>
<p><strong>In summary:</strong> We find that looking at this problem from the point of view of classifying <em>fast</em> vs <em>slow</em> trips helps us to see certains effects clearer and to notice useful details about for instance the spatial distributions or the impact of work hours. Furthermore, we derive helpful hints on how to encode otherwise randomly ordered categorical variables like <em>wday</em> (day of the week) or <em>month</em> (randomly with respect to trip duration).</p>
<p>This concludes our brief excursion into classification. <strong>I encourage any of you who are interested to take this classification approach and see how far you can take it.</strong></p>
<h1 id="A-simple-model-and-prediction"><a href="#A-simple-model-and-prediction" class="headerlink" title="A simple model and prediction"></a>A simple model and prediction</h1><p>In a brief final step we will feed our exploratory and engineering insights into a simple model to predict the target <em>trip_duration</em> for the <em>test</em> data set. However, this is primarily an EDA kernel and not a modelling one. This section leaves plenty of room for improvement for anyone who wants to optimise it. We will be using <em>XGBoost</em>, but you can try out any other algorithm.</p>
<p>I’m expecting that as time progresses in this competition the focus will shift towards the intricacies of model selection and tuning. I can think of a few more masters and grandmasters that I would like to see demonstrating their skills here, so that I can learn from them. For instance, this kernel won’t touch on the subject of model stacking at all.</p>
<h2 id="Preparations"><a href="#Preparations" class="headerlink" title="Preparations"></a>Preparations</h2><h3 id="Train-vs-test-overlap"><a href="#Train-vs-test-overlap" class="headerlink" title="Train vs test overlap"></a><em>Train</em> vs <em>test</em> overlap</h3><p>In order to make sure that we are really training on features that are relevant to our <em>test</em> data set we will now briefly compare the temporal and spatial properties of the <em>train</em> and <em>test</em> data. This is another consistency check. We could have done this before the exploration, but my personal preference is to examine the training data first before looking at the <em>test</em> data set so that my analysis is as unbiased as possible. Here are the two relevant comparison plots:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">foo &lt;- combine %&gt;%</span><br><span class="line"></span><br><span class="line">  mutate(date &#x3D; date(ymd_hms(pickup_datetime))) %&gt;%</span><br><span class="line"></span><br><span class="line">  group_by(date, dset) %&gt;%</span><br><span class="line"></span><br><span class="line">  count() %&gt;%</span><br><span class="line"></span><br><span class="line">  ungroup()</span><br><span class="line"></span><br><span class="line">foo %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(date, n&#x2F;1e3, color &#x3D; dset)) +</span><br><span class="line"></span><br><span class="line">  geom_line(size &#x3D; 1.5) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;&quot;, y &#x3D; &quot;Kilo trips per day&quot;)</span><br></pre></td></tr></table></figure>





<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">pick_good &lt;- combine %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(pickup_longitude &gt; -75 &amp; pickup_longitude &lt; -73) %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(pickup_latitude &gt; 40 &amp; pickup_latitude &lt; 42)</span><br><span class="line"></span><br><span class="line">pick_good &lt;- sample_n(pick_good, 5e3)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pick_good %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(pickup_longitude, pickup_latitude, color &#x3D; dset)) +</span><br><span class="line"></span><br><span class="line">  geom_point(size&#x3D;0.1, alpha &#x3D; 0.5) +</span><br><span class="line"></span><br><span class="line">  coord_cartesian(xlim &#x3D; c(-74.02,-73.77), ylim &#x3D; c(40.63,40.84)) +</span><br><span class="line"></span><br><span class="line">  facet_wrap(~ dset) +</span><br><span class="line"></span><br><span class="line">  #guides(color &#x3D; guide_legend(override.aes &#x3D; list(alpha &#x3D; 1, size &#x3D; 4))) +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;)</span><br></pre></td></tr></table></figure>



<p>We find that our <em>train</em> and <em>test</em> data sets do indeed cover the same time range and geographical area.</p>
<h3 id="Data-formatting"><a href="#Data-formatting" class="headerlink" title="Data formatting"></a>Data formatting</h3><p>Here we will format the selected features to turn them into integer columns, since many classifiers cannot deal with categorical values. For the encoding we make use of our exploratory knowledge, including the insights gained in our classification excursion. This is necessary since most classifiers would assume a natural ordering for integer features (i.e. 1 &lt; 2 &lt; 3 with respect to impact on the target). An alternative would be to use one-hot encoding.</p>
<p>In order for the encoding to be homogeneous between the <em>train</em> and <em>test</em> data sets it is a useful habit to perform it on the combined data, in case there are differences in some of the factor levels. For instance, if the <em>passenger_count</em> were a genuine factor feature then here the <em>train</em> and <em>test</em> data would contain different levels (since <em>test</em> is missing 7 and 8 passenger trips).</p>
<p>This formatting stage is practically a repeat of what we did at the beginning of the <em>Feature Engineering</em> section. In principle we could have already worked with the <em>combine</em> data set back then, but for the purpose of keeping it simple we used only the <em>train</em> sample back then. You are very welcome to take this kernel and improve it for better efficiency.</p>
<p>Nothing magical here in our engineering/formatting code block:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># airport coordinates again, just to be sure</span><br><span class="line"></span><br><span class="line">jfk_coord &lt;- tibble(lon &#x3D; -73.778889, lat &#x3D; 40.639722)</span><br><span class="line"></span><br><span class="line">la_guardia_coord &lt;- tibble(lon &#x3D; -73.872611, lat &#x3D; 40.77725)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># derive distances</span><br><span class="line"></span><br><span class="line">pick_coord &lt;- combine %&gt;%</span><br><span class="line"></span><br><span class="line">  select(pickup_longitude, pickup_latitude)</span><br><span class="line"></span><br><span class="line">drop_coord &lt;- combine %&gt;%</span><br><span class="line"></span><br><span class="line">  select(dropoff_longitude, dropoff_latitude)</span><br><span class="line"></span><br><span class="line">combine$dist &lt;- distCosine(pick_coord, drop_coord)</span><br><span class="line"></span><br><span class="line">combine$bearing &#x3D; bearing(pick_coord, drop_coord)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">combine$jfk_dist_pick &lt;- distCosine(pick_coord, jfk_coord)</span><br><span class="line"></span><br><span class="line">combine$jfk_dist_drop &lt;- distCosine(drop_coord, jfk_coord)</span><br><span class="line"></span><br><span class="line">combine$lg_dist_pick &lt;- distCosine(pick_coord, la_guardia_coord)</span><br><span class="line"></span><br><span class="line">combine$lg_dist_drop &lt;- distCosine(drop_coord, la_guardia_coord)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># add dates</span><br><span class="line"></span><br><span class="line">combine &lt;- combine %&gt;%</span><br><span class="line"></span><br><span class="line">  mutate(pickup_datetime &#x3D; ymd_hms(pickup_datetime),</span><br><span class="line"></span><br><span class="line">         dropoff_datetime &#x3D; ymd_hms(dropoff_datetime),</span><br><span class="line"></span><br><span class="line">         date &#x3D; date(pickup_datetime)</span><br><span class="line"></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># add weather info</span><br><span class="line"></span><br><span class="line">foo &lt;- weather %&gt;%</span><br><span class="line"></span><br><span class="line">  select(date, rain, s_fall, all_precip, has_snow, has_rain, s_depth, max_temp, min_temp)</span><br><span class="line"></span><br><span class="line">combine &lt;- left_join(combine, foo, by &#x3D; &quot;date&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># add fast routes</span><br><span class="line"></span><br><span class="line">foo &lt;- fastest_route %&gt;%</span><br><span class="line"></span><br><span class="line">  select(id, total_distance, total_travel_time, number_of_steps,</span><br><span class="line"></span><br><span class="line">         step_direction, step_maneuvers) %&gt;%</span><br><span class="line"></span><br><span class="line">  mutate(fastest_speed &#x3D; total_distance&#x2F;total_travel_time*3.6,</span><br><span class="line"></span><br><span class="line">         left_turns &#x3D; str_count(step_direction, &quot;left&quot;),</span><br><span class="line"></span><br><span class="line">         right_turns &#x3D; str_count(step_direction, &quot;right&quot;),</span><br><span class="line"></span><br><span class="line">         turns &#x3D; str_count(step_maneuvers, &quot;turn&quot;)</span><br><span class="line"></span><br><span class="line">         ) %&gt;%</span><br><span class="line"></span><br><span class="line">  select(-step_direction, -step_maneuvers)</span><br><span class="line"></span><br><span class="line">combine &lt;- left_join(combine, foo, by &#x3D; &quot;id&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># reformat to numerical and recode levels</span><br><span class="line"></span><br><span class="line">combine &lt;- combine %&gt;%</span><br><span class="line"></span><br><span class="line">  mutate(store_and_fwd_flag &#x3D; as.integer(factor(store_and_fwd_flag)),</span><br><span class="line"></span><br><span class="line">         vendor_id &#x3D; as.integer(vendor_id),</span><br><span class="line"></span><br><span class="line">         month &#x3D; as.integer(month(pickup_datetime)),</span><br><span class="line"></span><br><span class="line">         wday &#x3D; wday(pickup_datetime, label &#x3D; TRUE),</span><br><span class="line"></span><br><span class="line">         wday &#x3D; as.integer(fct_relevel(wday, c(&quot;Sun&quot;, &quot;Sat&quot;, &quot;Mon&quot;, &quot;Tues&quot;, &quot;Wed&quot;, &quot;Thurs&quot;, &quot;Fri&quot;))),</span><br><span class="line"></span><br><span class="line">         hour &#x3D; hour(pickup_datetime),</span><br><span class="line"></span><br><span class="line">         work &#x3D; as.integer( (hour %in% seq(8,18)) &amp; (wday %in% c(&quot;Mon&quot;,&quot;Tues&quot;,&quot;Fri&quot;,&quot;Wed&quot;,&quot;Thurs&quot;)) ),</span><br><span class="line"></span><br><span class="line">         jfk_trip &#x3D; as.integer( (jfk_dist_pick &lt; 2e3) | (jfk_dist_drop &lt; 2e3) ),</span><br><span class="line"></span><br><span class="line">         lg_trip &#x3D; as.integer( (lg_dist_pick &lt; 2e3) | (lg_dist_drop &lt; 2e3) ),</span><br><span class="line"></span><br><span class="line">         has_rain &#x3D; as.integer(has_rain),</span><br><span class="line"></span><br><span class="line">         has_snow &#x3D; as.integer(has_snow),</span><br><span class="line"></span><br><span class="line">         blizzard &#x3D; as.integer( !( (date &lt; ymd(&quot;2016-01-22&quot;) | (date &gt; ymd(&quot;2016-01-29&quot;)))) )</span><br><span class="line"></span><br><span class="line">         )</span><br></pre></td></tr></table></figure>



<p>You might have noticed that we now recode the weekdays (<em>wday</em>) according to the results from the classification section. Conveniently, the <em>months</em> are already in a sequence of increasing fraction of slow trips. (Anybody got an idea why this could be?)</p>
<p>Consistency check:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">glimpse(combine)</span><br></pre></td></tr></table></figure>



<p>Looks good. The only non-numerical features are <em>id</em>, <em>pickup_datetime</em>, <em>dropoff_datetime</em>, and <em>date</em>, which will remove in any case, together with <em>dset</em> which we will use now to separate the <em>train</em> vs <em>test</em> again.</p>
<h3 id="Feature-selection-metric-adjustment-validation-split-and-careful-cleaning"><a href="#Feature-selection-metric-adjustment-validation-split-and-careful-cleaning" class="headerlink" title="Feature selection, metric adjustment, validation split, and careful cleaning"></a>Feature selection, metric adjustment, validation split, and careful cleaning</h3><p>Not all features in our data set will be useful. Here we only include meaningful variables and remove for instance the <em>id</em> feature and most of the weather features.</p>
<p>In principle, we could include all features and leave the selection of the useful ones to our modelling algorithm. However, in our case a pre-selection could be useful because we have (a) engineered a couple of features from existing ones (such as <em>work</em> or <em>blizzard</em>), and (b) imported additional features with strong correlation (such as <em>total_distance</em> and <em>total_travel_time</em>). Both strategies can cause significant <em>collinearity</em> within our training feature set, which will make it more difficult to interpret the result of our model in terms of the impact of individual features. Furthermore, from a pragmatic point of view any strongly correlated features don’t add much new information and should (in my opinion) be removed for reasons of statistical parsimony.</p>
<p>Feature selection is normally an iterative process where we run an initial model with either few or many features and then step-by-step add or remove some features based on the results of the previous run. For the sake of kernel run time here we only include one model fitting step. You are very welcome to use it as a starting point for your own analysis and combine it with insights from other kernels. We will base our feature selection on the results of the exploratory analysis, in particular the final correlation matrix.</p>
<p>In this code block, the feature selection is structured with a little more detail than necessary, in order to make it easier to generalise it to a new problem:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># Specific definitions:</span><br><span class="line"></span><br><span class="line">#---------------------------------</span><br><span class="line"></span><br><span class="line"># predictor features</span><br><span class="line"></span><br><span class="line">train_cols &lt;- c(&quot;total_travel_time&quot;, &quot;total_distance&quot;, &quot;hour&quot;, &quot;dist&quot;,</span><br><span class="line"></span><br><span class="line">                &quot;vendor_id&quot;, &quot;jfk_trip&quot;, &quot;lg_trip&quot;, &quot;wday&quot;, &quot;month&quot;,</span><br><span class="line"></span><br><span class="line">                &quot;pickup_longitude&quot;, &quot;pickup_latitude&quot;, &quot;bearing&quot;, &quot;lg_dist_drop&quot;)</span><br><span class="line"></span><br><span class="line"># target feature</span><br><span class="line"></span><br><span class="line">y_col &lt;- c(&quot;trip_duration&quot;)</span><br><span class="line"></span><br><span class="line"># identification feature</span><br><span class="line"></span><br><span class="line">id_col &lt;- c(&quot;id&quot;) </span><br><span class="line"></span><br><span class="line"># auxilliary features</span><br><span class="line"></span><br><span class="line">aux_cols &lt;- c(&quot;dset&quot;)</span><br><span class="line"></span><br><span class="line"># cleaning features</span><br><span class="line"></span><br><span class="line">clean_cols &lt;- c(&quot;jfk_dist_drop&quot;, &quot;jfk_dist_pick&quot;)</span><br><span class="line"></span><br><span class="line">#---------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># General extraction</span><br><span class="line"></span><br><span class="line">#---------------------------------</span><br><span class="line"></span><br><span class="line"># extract test id column</span><br><span class="line"></span><br><span class="line">test_id &lt;- combine %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(dset &#x3D;&#x3D; &quot;test&quot;) %&gt;%</span><br><span class="line"></span><br><span class="line">  select_(.dots &#x3D; id_col)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># all relevant columns for train&#x2F;test</span><br><span class="line"></span><br><span class="line">cols &lt;- c(train_cols, y_col, aux_cols, clean_cols)</span><br><span class="line"></span><br><span class="line">combine &lt;- combine %&gt;%</span><br><span class="line"></span><br><span class="line">  select_(.dots &#x3D; cols)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># split train&#x2F;test</span><br><span class="line"></span><br><span class="line">train &lt;- combine %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(dset &#x3D;&#x3D; &quot;train&quot;) %&gt;%</span><br><span class="line"></span><br><span class="line">  select_(.dots &#x3D; str_c(&quot;-&quot;,c(aux_cols)))</span><br><span class="line"></span><br><span class="line">test &lt;- combine %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(dset &#x3D;&#x3D; &quot;test&quot;) %&gt;%</span><br><span class="line"></span><br><span class="line">  select_(.dots &#x3D; str_c(&quot;-&quot;,c(aux_cols, clean_cols, y_col)))</span><br><span class="line"></span><br><span class="line">#---------------------------------</span><br></pre></td></tr></table></figure>



<p>For our taxi challenge, the evaluation metric is <a href="https://www.kaggle.com/c/nyc-taxi-trip-duration#evaluation" target="_blank" rel="noopener">RMSLE</a>, the <a href="https://www.kaggle.com/wiki/RootMeanSquaredLogarithmicError" target="_blank" rel="noopener">Root Mean Squared Logarithmic Error</a>. Essentially, this means that we are optimising the prediction vs data deviations in log space. This has the advantage that large individual outliers don’t get as much weight as they would in a linear metric.</p>
<p>In order to easily simulate the evaluation metric in our model fitting we replace the <em>trip_duration</em> with its logarithm. (The <code>+ 1</code> is added to avoid an undefined <code>log(0)</code> and we need to remember to remove this 1 second for the prediction file, although it shouldn’t make a huge difference if we didn’t.)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">train &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  mutate(trip_duration &#x3D; log(trip_duration + 1))</span><br></pre></td></tr></table></figure>



<p>In order to assess how well our model generalises we will perform a cross-validation step and also split our training data into a <em>train</em> vs <em>validation</em> data set. Thereby, the model performance can be evaluated on a sample that the algorithm has not seen. We split our data into 80/20 fractions using a tool from the <a href="https://cran.r-project.org/web/packages/caret/index.html" target="_blank" rel="noopener">caret package</a>. We wouldn’t really need this package here for such a simple task, but I’m including it to give it a mention. <em>Caret</em> is a multi-purpose ML package that is certainly worth checking out.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">set.seed(4321)</span><br><span class="line"></span><br><span class="line">trainIndex &lt;- createDataPartition(train$trip_duration, p &#x3D; 0.8, list &#x3D; FALSE, times &#x3D; 1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">train &lt;- train[trainIndex,]</span><br><span class="line"></span><br><span class="line">valid &lt;- train[-trainIndex,]</span><br></pre></td></tr></table></figure>



<p>Finally, we are performing careful cleaning steps on our <em>train</em> sample only. By removing observations from the training data we always run the risk of overfitting our model to a more “idealised” version of reality. In particular for the current data set, where lots of values don’t make obvious sense, this idealised model might not generalise well to unseen data, which could have similar “quirks”. For this reason, we are keeping the validation sample unchanged, so that any noticeable deviations between <em>train</em> and <em>valid</em> model score can alert us to overfitting.</p>
<p>Why clean at all? Well, in my opinion obvious outliers should be removed to make the model robust. It’s true that these outliers might also exist in the <em>test</em> data, but if there is a way to predict them then this suggests that they might not be outliers after all. And if we can’t predict them there’s no way to take them into account anyway. Lastly, the answer also depends on the <em>goal</em> of your analysis (and your evaluation metric) which might not always aim at fitting a given <em>test</em> set as good as possible but sometimes have a more pragmatic target that allows you to ignore extreme values.</p>
<p>Here we only remove the few <em>trip_duration</em> that are longer than a day and the couple of data points far, far away from NYC:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">valid &lt;- valid %&gt;%</span><br><span class="line"></span><br><span class="line">  select_(.dots &#x3D; str_c(&quot;-&quot;,c(clean_cols)))</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">train &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  filter(trip_duration &lt; 24*3600,</span><br><span class="line"></span><br><span class="line">         jfk_dist_pick &lt; 3e5 &amp; jfk_dist_drop &lt; 3e5</span><br><span class="line"></span><br><span class="line">         ) %&gt;%</span><br><span class="line"></span><br><span class="line">  select_(.dots &#x3D; str_c(&quot;-&quot;,c(clean_cols)))</span><br></pre></td></tr></table></figure>





<h2 id="XGBoost-parameters-and-fitting"><a href="#XGBoost-parameters-and-fitting" class="headerlink" title="XGBoost parameters and fitting"></a>XGBoost parameters and fitting</h2><p>For the model fitting we will use everybody’s favourite <em>XGBoost - eXtreme Gradient Boosting</em>. This is a decision-tree gradient boosting algorithm with a high degree of popularity here on Kaggle. In this kernel we will implement a fairly straight-forward fitting strategy. Feel free to optimise the parameters and get some inspiration from <a href="https://www.kaggle.com/gaborfodor/from-eda-to-the-top-lb-0-367/" target="_blank" rel="noopener">other kernels</a> that are more focussed on model fitting. Also try out other classifiers, such as <a href="https://www.kaggle.com/mrisdal/last-place-laura-benchmark/" target="_blank" rel="noopener">Megan’s baseline Random Forest</a> to see how they treat our features.</p>
<p>A few brief words about <em>gradient boosting</em>, as far as I understand it: Boosting is what we call the step-by-step improvement of a weak learner (like a relatively shallow decision tree of <em>max_depth</em> levels) by successively applying it to the results of the previous learning step (for <em>nrounds</em> times in total). <em>Gradient Boosting</em> focusses on minimising the Loss Function (according to our evaluation metric) by training the algorithm on the gradient of this function. The method of <em>Gradient Decent</em> iteratively moves into the direction of the greatest decent (i.e. most negative first derivative) of the loss function. The step sizes can vary from iteration to iteration but has a multiplicative <em>shrinkage factor eta in (0,1]</em> associated with it for additional tuning. Smaller values of eta result in a slower decent and require higher <em>nrounds</em>.</p>
<p>In order for <em>XGBoost</em> to properly ingest our data samples we need to re-format them slightly:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#convert to XGB matrix</span><br><span class="line"></span><br><span class="line">foo &lt;- train %&gt;% select(-trip_duration)</span><br><span class="line"></span><br><span class="line">bar &lt;- valid %&gt;% select(-trip_duration)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dtrain &lt;- xgb.DMatrix(as.matrix(foo),label &#x3D; train$trip_duration)</span><br><span class="line"></span><br><span class="line">dvalid &lt;- xgb.DMatrix(as.matrix(bar),label &#x3D; valid$trip_duration)</span><br><span class="line"></span><br><span class="line">dtest &lt;- xgb.DMatrix(as.matrix(test))</span><br></pre></td></tr></table></figure>





<p>Now we define the meta-parameters that govern how <em>XGBoost</em> operates. See <a href="https://github.com/dmlc/xgboost/blob/master/doc/parameter.md" target="_blank" rel="noopener">here</a> for more details. The <em>watchlist</em> parameter tells the algorithm to keep an eye on both the <em>training</em> and <em>validation</em> sample metrics. Those parameters are not optimised for performance, so feel free to play with them:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">xgb_params &lt;- list(colsample_bytree &#x3D; 0.7, #variables per tree </span><br><span class="line"></span><br><span class="line">                   subsample &#x3D; 0.7, #data subset per tree </span><br><span class="line"></span><br><span class="line">                   booster &#x3D; &quot;gbtree&quot;,</span><br><span class="line"></span><br><span class="line">                   max_depth &#x3D; 5, #tree levels</span><br><span class="line"></span><br><span class="line">                   eta &#x3D; 0.3, #shrinkage</span><br><span class="line"></span><br><span class="line">                   eval_metric &#x3D; &quot;rmse&quot;, </span><br><span class="line"></span><br><span class="line">                   objective &#x3D; &quot;reg:linear&quot;,</span><br><span class="line"></span><br><span class="line">                   seed &#x3D; 4321</span><br><span class="line"></span><br><span class="line">                   )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">watchlist &lt;- list(train&#x3D;dtrain, valid&#x3D;dvalid)</span><br></pre></td></tr></table></figure>



<p>And here we <em>train</em> our classifier, i.e. fit it to the <em>training</em> data. To ensure reproducability we set an R seed here. To make this model run in the kernel environment, given our extensive EDA run time, we will restrict the learning to 60 sample rounds. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">set.seed(4321)</span><br><span class="line"></span><br><span class="line">gb_dt &lt;- xgb.train(params &#x3D; xgb_params,</span><br><span class="line"></span><br><span class="line">                   data &#x3D; dtrain,</span><br><span class="line"></span><br><span class="line">                   print_every_n &#x3D; 5,</span><br><span class="line"></span><br><span class="line">                   watchlist &#x3D; watchlist,</span><br><span class="line"></span><br><span class="line">                   nrounds &#x3D; 60)</span><br></pre></td></tr></table></figure>



<p>After the fitting we are running a 5-fold cross-validation (CV) to estimate our model’s performance. Also this stage would exceed the Kaggle run-time limit for a larger number of rounds, therefore I’m limiting it here to 15 sample rounds to demonstrate the principle. You should use at least a few 100 in your analysis, depending on your XGBoost parameters. The early-stopping parameter will make sure that the CV fitting is stopped once the model can’t be improved through additional steps.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">xgb_cv &lt;- xgb.cv(xgb_params,dtrain,early_stopping_rounds &#x3D; 10, nfold &#x3D; 5, nrounds&#x3D;15)</span><br></pre></td></tr></table></figure>





<h2 id="Feature-importance"><a href="#Feature-importance" class="headerlink" title="Feature importance"></a>Feature importance</h2><p>After training we will check which features are the most important for our model. This can provide the starting point for an iterative process where we identify, step by step, the significant features for a model. Here we will simply visualise these features:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">imp_matrix &lt;- as.tibble(xgb.importance(feature_names &#x3D; colnames(train %&gt;% select(-trip_duration)), model &#x3D; gb_dt))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">imp_matrix %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(reorder(Feature, Gain, FUN &#x3D; max), Gain, fill &#x3D; Feature)) +</span><br><span class="line"></span><br><span class="line">  geom_col() +</span><br><span class="line"></span><br><span class="line">  coord_flip() +</span><br><span class="line"></span><br><span class="line">  theme(legend.position &#x3D; &quot;none&quot;) +</span><br><span class="line"></span><br><span class="line">  labs(x &#x3D; &quot;Features&quot;, y &#x3D; &quot;Importance&quot;)</span><br></pre></td></tr></table></figure>



<p>We find that, unsurprisingly, the OSRM features like <em>total_distance</em> and <em>total_travel_time</em> are by far the most important predictors for the <em>trip_duration</em>. Beyond that, our engineered features like <em>wday</em> or <em>bearing</em> are not doing bad either.</p>
<h2 id="Prediction-and-submission-file"><a href="#Prediction-and-submission-file" class="headerlink" title="Prediction and submission file"></a>Prediction and submission file</h2><p>Once we are reasonably happy with our CV score we use the corresponding model to make a prediction for the test data, write the submission file, and submit it to the Kaggle leaderboard. This gives a performance score based on an <em>independent</em> data set. For this very reason, it is advisable to aim to keep the number of leaderboard submission low. Otherwise you run the risk to have your model influenced too much by this public leaderboard data which will result in overfitting. It’s better to trust your local CV. Just ask anyone who has just completed the Mercedes challenge ;-)</p>
<p>Practically, this pre-ulimate code block will apply the <em>XGBoost</em> model to the testing data and write a submission file according to the competition specification. You will then find the file <code>submit.csv</code> in the “Output” tab of the Kaggle kernel or, if you have run the script locally, in the source directory.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">test_preds &lt;- predict(gb_dt,dtest)</span><br><span class="line"></span><br><span class="line">pred &lt;- test_id %&gt;%</span><br><span class="line"></span><br><span class="line">  mutate(trip_duration &#x3D; exp(test_preds) - 1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pred %&gt;% write_csv(&#39;submit.csv&#39;)</span><br></pre></td></tr></table></figure>



<p>All that’s left to do is to double-check this submission file to make sure that we are not wasting a (potentially) valuable submission with a mal-formatted output file. We are comparing its shape and content with the <em>sample submission file</em> that we read in at the very beginning, and also plot the distribution of the predicted values compared to the training values for an approximate comparison:</p>
<figure class="highlight plain"><figcaption><span>fig.align </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">identical(dim(sample_submit),dim(pred))</span><br><span class="line"></span><br><span class="line">glimpse(sample_submit)</span><br><span class="line"></span><br><span class="line">glimpse(pred)</span><br><span class="line"></span><br><span class="line">bind_cols(sample_submit, pred) %&gt;% head(5)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">foo &lt;- train %&gt;%</span><br><span class="line"></span><br><span class="line">  select(trip_duration) %&gt;%</span><br><span class="line"></span><br><span class="line">  mutate(dset &#x3D; &quot;train&quot;,</span><br><span class="line"></span><br><span class="line">         trip_duration &#x3D; exp(trip_duration) - 1)</span><br><span class="line"></span><br><span class="line">bar &lt;- pred %&gt;%</span><br><span class="line"></span><br><span class="line">  mutate(dset &#x3D; &quot;predict&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bind_rows(foo, bar) %&gt;%</span><br><span class="line"></span><br><span class="line">  ggplot(aes(trip_duration, fill &#x3D; dset)) +</span><br><span class="line"></span><br><span class="line">  geom_density(alpha &#x3D; 0.5) +</span><br><span class="line"></span><br><span class="line">  scale_x_log10()</span><br></pre></td></tr></table></figure>



<p>Prediction file format and <em>trip_duration</em> range successfully verified.</p>
<p>In its present state, this model will give you a score of 0.410 on the public leaderboard which, at the time of writing, will put you in the top 40% of submissions. Clearly this is just a starting point for you to explore and improve the modelling process. Here are a few suggestions:</p>
<ul>
<li>First of all, run the training and cross-validation for a larger number of rounds. This alone will immediately improve your score.</li>
</ul>
<ul>
<li>Add further features to the model and explore the impact of more or less cleaning.</li>
</ul>
<ul>
<li>Try out different XGBoost parameters and see how they affect the CV score.</li>
</ul>
<p>The rest is up to you. I hope that this extensive EDA gave you useful insights into the data as well as ideas to get you started with your own analysis. I wish you the best of success.</p>
<hr>
<p>Many thanks to all of you for reading, commenting on, and upvoting this kernel! This competition was an awesome experience for me and I hope you enjoyed it as well.</p>
<p>See you at the next challenge! :-)</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  ﻿
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/8/">向前翻</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Yilun Liu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">36</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Ealen" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:ealenliu@foxmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://scholar.google.com/citations?user=HB9EqogAAAAJ&hl=zh-CN" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i>Google</a>
                  </span>
                
            </div>
          

          
          

          
          

          
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5mtu3i1pvhk&amp;m=7&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=49" async="async"></script>
        </div>
      </section>

      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yilun Liu</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count"></span>
  
</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

  
</div>








        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://geo-spv.disqus.com/count.js" async></script>
    

    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.4"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.4"></script>


  

</body>
</html>
